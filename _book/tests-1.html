<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Tests | dbt Book</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Tests | dbt Book" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Tests | dbt Book" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="Samuel Gachuhi Ngugi" />


<meta name="date" content="2024-10-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="documentation-1.html"/>
<link rel="next" href="dbt-expectations-package.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#usage"><i class="fa fa-check"></i><b>1.1</b> Usage</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#render-book"><i class="fa fa-check"></i><b>1.2</b> Render book</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#preview-book"><i class="fa fa-check"></i><b>1.3</b> Preview book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#what-is-dbt"><i class="fa fa-check"></i><b>2.1</b> What is dbt?</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#encounter-with-dbt"><i class="fa fa-check"></i><b>2.2</b> Encounter with <code>dbt</code></a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#dbt-from-the-professionals"><i class="fa fa-check"></i><b>2.3</b> dbt, from the professionals…</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#why-use-dbt"><i class="fa fa-check"></i><b>2.4</b> Why use dbt?</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html"><i class="fa fa-check"></i><b>3</b> The <code>dbt</code> architecture</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#models"><i class="fa fa-check"></i><b>3.0.1</b> Models</a></li>
<li class="chapter" data-level="3.0.2" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#tests"><i class="fa fa-check"></i><b>3.0.2</b> Tests</a></li>
<li class="chapter" data-level="3.0.3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#documentation"><i class="fa fa-check"></i><b>3.0.3</b> Documentation</a></li>
<li class="chapter" data-level="3.0.4" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#sources"><i class="fa fa-check"></i><b>3.0.4</b> Sources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-storage.html"><a href="data-storage.html"><i class="fa fa-check"></i><b>4</b> Data storage</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-storage.html"><a href="data-storage.html#data-warehouse"><i class="fa fa-check"></i><b>4.1</b> Data warehouse</a></li>
<li class="chapter" data-level="4.2" data-path="data-storage.html"><a href="data-storage.html#data-lake"><i class="fa fa-check"></i><b>4.2</b> Data lake</a></li>
<li class="chapter" data-level="4.3" data-path="data-storage.html"><a href="data-storage.html#data-lakehouse"><i class="fa fa-check"></i><b>4.3</b> Data lakehouse</a></li>
<li class="chapter" data-level="4.4" data-path="data-storage.html"><a href="data-storage.html#a-brief-history"><i class="fa fa-check"></i><b>4.4</b> A brief history</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html"><i class="fa fa-check"></i><b>5</b> Our data in BigQuery</a>
<ul>
<li class="chapter" data-level="5.1" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#accessing-big-query"><i class="fa fa-check"></i><b>5.1</b> Accessing Big Query</a></li>
<li class="chapter" data-level="5.2" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#copying-the-new-york-city-bikes-data"><i class="fa fa-check"></i><b>5.2</b> Copying the New York City Bikes data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="installing-dbt.html"><a href="installing-dbt.html"><i class="fa fa-check"></i><b>6</b> Installing dbt</a>
<ul>
<li class="chapter" data-level="6.1" data-path="installing-dbt.html"><a href="installing-dbt.html#setting-the-environment"><i class="fa fa-check"></i><b>6.1</b> Setting the environment</a></li>
<li class="chapter" data-level="6.2" data-path="installing-dbt.html"><a href="installing-dbt.html#connecting-to-your-bigquery-data-warehouse"><i class="fa fa-check"></i><b>6.2</b> Connecting to your BigQuery data warehouse</a></li>
<li class="chapter" data-level="6.3" data-path="installing-dbt.html"><a href="installing-dbt.html#initializing-a-dbt-project"><i class="fa fa-check"></i><b>6.3</b> Initializing a dbt project</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="models-1.html"><a href="models-1.html"><i class="fa fa-check"></i><b>7</b> Models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="models-1.html"><a href="models-1.html#running-a-model"><i class="fa fa-check"></i><b>7.1</b> Running a model</a></li>
<li class="chapter" data-level="7.2" data-path="models-1.html"><a href="models-1.html#model-structure"><i class="fa fa-check"></i><b>7.2</b> Model structure</a></li>
<li class="chapter" data-level="7.3" data-path="models-1.html"><a href="models-1.html#a-custom-model"><i class="fa fa-check"></i><b>7.3</b> A custom model</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="documentation-1.html"><a href="documentation-1.html"><i class="fa fa-check"></i><b>8</b> Documentation</a>
<ul>
<li class="chapter" data-level="8.1" data-path="documentation-1.html"><a href="documentation-1.html#the-yml-files"><i class="fa fa-check"></i><b>8.1</b> The yml files</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="documentation-1.html"><a href="documentation-1.html#version-2"><i class="fa fa-check"></i><b>8.1.1</b> <code>version: 2</code></a></li>
<li class="chapter" data-level="8.1.2" data-path="documentation-1.html"><a href="documentation-1.html#models-2"><i class="fa fa-check"></i><b>8.1.2</b> <code>models</code></a></li>
<li class="chapter" data-level="8.1.3" data-path="documentation-1.html"><a href="documentation-1.html#description"><i class="fa fa-check"></i><b>8.1.3</b> <code>description</code></a></li>
<li class="chapter" data-level="8.1.4" data-path="documentation-1.html"><a href="documentation-1.html#columns"><i class="fa fa-check"></i><b>8.1.4</b> <code>columns</code></a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="documentation-1.html"><a href="documentation-1.html#definition-for-our-model"><i class="fa fa-check"></i><b>8.2</b> Definition for our model</a></li>
<li class="chapter" data-level="8.3" data-path="documentation-1.html"><a href="documentation-1.html#using-the-doc-function"><i class="fa fa-check"></i><b>8.3</b> Using the <code>doc</code> function</a></li>
<li class="chapter" data-level="8.4" data-path="documentation-1.html"><a href="documentation-1.html#images-in-dbt-documentation"><i class="fa fa-check"></i><b>8.4</b> Images in dbt documentation</a></li>
<li class="chapter" data-level="8.5" data-path="documentation-1.html"><a href="documentation-1.html#generating-the-document"><i class="fa fa-check"></i><b>8.5</b> Generating the document</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="tests-1.html"><a href="tests-1.html"><i class="fa fa-check"></i><b>9</b> Tests</a>
<ul>
<li class="chapter" data-level="9.1" data-path="tests-1.html"><a href="tests-1.html#types-of-tests-in-dbt"><i class="fa fa-check"></i><b>9.1</b> Types of tests in dbt</a></li>
<li class="chapter" data-level="9.2" data-path="tests-1.html"><a href="tests-1.html#generic-tests-in-dbt"><i class="fa fa-check"></i><b>9.2</b> Generic tests in dbt</a></li>
<li class="chapter" data-level="9.3" data-path="tests-1.html"><a href="tests-1.html#singular-tests-in-dbt"><i class="fa fa-check"></i><b>9.3</b> Singular tests in dbt</a></li>
<li class="chapter" data-level="9.4" data-path="tests-1.html"><a href="tests-1.html#creating-a-generic-test"><i class="fa fa-check"></i><b>9.4</b> Creating a generic test</a></li>
<li class="chapter" data-level="9.5" data-path="tests-1.html"><a href="tests-1.html#configuring-custom-generic-tests"><i class="fa fa-check"></i><b>9.5</b> Configuring custom generic tests</a></li>
<li class="chapter" data-level="9.6" data-path="tests-1.html"><a href="tests-1.html#storing-test-failures"><i class="fa fa-check"></i><b>9.6</b> Storing test failures</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html"><i class="fa fa-check"></i><b>10</b> dbt Expectations package</a>
<ul>
<li class="chapter" data-level="10.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#dbt-expectations-installation"><i class="fa fa-check"></i><b>10.1</b> <code>dbt-expectations</code> installation</a></li>
<li class="chapter" data-level="10.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#types-of-dbt-expectations-tests"><i class="fa fa-check"></i><b>10.2</b> Types of <code>dbt-expectations</code> tests</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#table-shape"><i class="fa fa-check"></i><b>10.2.1</b> Table shape</a></li>
<li class="chapter" data-level="10.2.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#missing-values-unique-values-and-types"><i class="fa fa-check"></i><b>10.2.2</b> Missing values, unique values, and types</a></li>
<li class="chapter" data-level="10.2.3" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#sets-and-ranges"><i class="fa fa-check"></i><b>10.2.3</b> Sets and Ranges</a></li>
<li class="chapter" data-level="10.2.4" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#string-matching"><i class="fa fa-check"></i><b>10.2.4</b> String matching</a></li>
<li class="chapter" data-level="10.2.5" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#aggregate"><i class="fa fa-check"></i><b>10.2.5</b> Aggregate</a></li>
<li class="chapter" data-level="10.2.6" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#multi-column"><i class="fa fa-check"></i><b>10.2.6</b> Multi-column</a></li>
<li class="chapter" data-level="10.2.7" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#distributional-functions"><i class="fa fa-check"></i><b>10.2.7</b> Distributional functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="seeds.html"><a href="seeds.html"><i class="fa fa-check"></i><b>11</b> Seeds</a>
<ul>
<li class="chapter" data-level="11.1" data-path="seeds.html"><a href="seeds.html#uploading-a-seed-into-your-data-warehouse"><i class="fa fa-check"></i><b>11.1</b> Uploading a seed into your data warehouse</a></li>
<li class="chapter" data-level="11.2" data-path="seeds.html"><a href="seeds.html#referencing-seeds-in-models"><i class="fa fa-check"></i><b>11.2</b> Referencing seeds in models</a></li>
<li class="chapter" data-level="11.3" data-path="seeds.html"><a href="seeds.html#seed-configurations-at-project-level"><i class="fa fa-check"></i><b>11.3</b> Seed Configurations at project level</a></li>
<li class="chapter" data-level="11.4" data-path="seeds.html"><a href="seeds.html#seed-properties-and-configurations-at-properties-level"><i class="fa fa-check"></i><b>11.4</b> Seed properties and configurations at properties level</a></li>
<li class="chapter" data-level="11.5" data-path="seeds.html"><a href="seeds.html#performing-tests-on-seeds"><i class="fa fa-check"></i><b>11.5</b> Performing tests on seeds</a></li>
<li class="chapter" data-level="11.6" data-path="seeds.html"><a href="seeds.html#viewing-documentation-for-dbt-seeds"><i class="fa fa-check"></i><b>11.6</b> Viewing documentation for dbt seeds</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="sources-1.html"><a href="sources-1.html"><i class="fa fa-check"></i><b>12</b> Sources</a>
<ul>
<li class="chapter" data-level="12.1" data-path="sources-1.html"><a href="sources-1.html#defining-a-source"><i class="fa fa-check"></i><b>12.1</b> Defining a source</a></li>
<li class="chapter" data-level="12.2" data-path="sources-1.html"><a href="sources-1.html#referencing-sources"><i class="fa fa-check"></i><b>12.2</b> Referencing sources</a></li>
<li class="chapter" data-level="12.3" data-path="sources-1.html"><a href="sources-1.html#defining-properties-in-a-sources-file"><i class="fa fa-check"></i><b>12.3</b> Defining properties in a <code>sources</code> file</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">dbt Book</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tests-1" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Tests<a href="tests-1.html#tests-1" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Probably if you’ve worked on a Windows computer, you must have used Microsoft Defender Full Scan at some point. During or at the end of the scan, some results were displayed. dbt works in almost the same way, only that this time they scan your data.</p>
<p>Tests in dbt are basically assertions of your data. That is, they are just some assumptions that you have of your datasets or columns that are correct. Tests enable one to know 1) which assumptions are wrong about our data, and 2) which parts of our data diverge from the expected norm. Tests can sometimes feal like something to bemoan, can fail (as all tests do) but the overarching advantage is that they make us understand more about our data. They can also be lifesavers in that they can pinpoint a serious problem which could be harder to debug if not more injurious to the integrity of your data later on! In a nutshell, dbt tests perform much like a programmatic scan that will only spew out errors of something that is suspicious.</p>
<div id="types-of-tests-in-dbt" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Types of tests in dbt<a href="tests-1.html#types-of-tests-in-dbt" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In dbt, a test can be defined in either of the following two ways:</p>
<ol style="list-style-type: decimal">
<li>generic test - this is a test written in a SQL model and defined inside a YAML file. The test in the YAML file is defined using jinja Macros. dbt comes with four shipped, all-batteries included tests namely:</li>
</ol>
<ul>
<li>unique - asserts that the column has no repeating values</li>
<li>not_null - asserts that there are no null values</li>
<li>accepted_values - checks if the values in your field correspond to those in a defined list</li>
<li>relationships - checks if the field has an existing relationship with another field in a different table.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>singular test - some normally refer to this as a custom test. This is a SQL query which is used to check assertions in your data. The SQL files that make up your test are defined inside the <code>tests</code> directory or the path defined in the <code>test-paths</code> key inside the <code>dbt_project.yml</code> file. Each SQL file will have one test only. Nevertheless, if this test will be used across many fields and files, you can reference it using jinja macros <code>{{ }}</code>. If this is the case, it is no longer singular test but a generic <em>custom</em> test.</li>
</ol>
<p>Let’s start with a dbt out-of-the-box generic test.</p>
</div>
<div id="generic-tests-in-dbt" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Generic tests in dbt<a href="tests-1.html#generic-tests-in-dbt" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will start with a very simple test, the <code>not_null</code> test on the <code>start_station_name</code> column of <code>citi_trips_long</code> model. Surely, unless you are teleporting from somewhere, every rented bike must have an origin.</p>
<pre><code>
- name: citi_trips_long
    description: &#39;{{ doc(&quot;citi_trips_long&quot;) }}&#39;
    columns:
      - name: starttime
        description: &#39;{{ doc(&quot;starttime&quot;) }}&#39;

      --snip--

      - name: start_station_name
        description: &quot;Start Station Name&quot;
        tests:
          - not_null
          </code></pre>
<p>We use the below code to test only those models under <code>my_models</code> folder.</p>
<pre><code>dbt test --select my_models</code></pre>
<p>Here is the output.</p>
<pre><code>--snip--

19:15:33  Concurrency: 1 threads (target=&#39;dev&#39;)
19:15:33  
19:15:33  1 of 1 START test not_null_citi_trips_long_start_station_name .................. [RUN]
19:15:36  1 of 1 PASS not_null_citi_trips_long_start_station_name ........................ [PASS in 3.20s]
19:15:36  
19:15:36  Finished running 1 test in 0 hours 0 minutes and 4.44 seconds (4.44s).
19:15:36  
19:15:36  Completed successfully
19:15:36  
19:15:36  Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
</code></pre>
<p>If we had gone with the more blanket code of <code>dbt test</code>, it would have also tested those models under the shipped <code>examples</code> folder where there is already a test designed to fail, purely for educational purposes. Back to our <code>citi_trips_long</code> model, we can see that the test passed successfully. As expected, there are no null values in our <code>start_station_name</code> field. If the opposite happened, we suspect that this could be a case of fraud or some paranormal activities…</p>
<p>Now let’s create a test that will fail on purpose. From a large dataset, obviously the station names can’t be unique all through. So we insert the <code>unique</code> value under the <code>tests</code> key as follows.</p>
<pre><code>- name: start_station_name
        description: &quot;Start Station Name&quot;
        tests:
          - not_null
          - unique</code></pre>
<p>The output is as below. Note that it results in a failure and also shows the path to the SQL query that was used to carry out the test inside the <code>target/</code> directory. The resultant SQL path inside the target directory, if pasted in a SQL tab of your data warehouse will return the number of rows that <em>fail</em> the test.</p>
<pre><code>19:23:35  Concurrency: 1 threads (target=&#39;dev&#39;)
19:23:35  
19:23:35  1 of 2 START test not_null_citi_trips_long_start_station_name .................. [RUN]
19:23:38  1 of 2 PASS not_null_citi_trips_long_start_station_name ........................ [PASS in 3.01s]
19:23:38  2 of 2 START test unique_citi_trips_long_start_station_name .................... [RUN]
19:23:41  2 of 2 FAIL 910 unique_citi_trips_long_start_station_name ...................... [FAIL 910 in 2.68s]
19:23:41  
19:23:41  Finished running 2 data tests in 0 hours 0 minutes and 6.78 seconds (6.78s).
19:23:41  
19:23:41  Completed with 1 error and 0 warnings:
19:23:41  
19:23:41  Failure in test unique_citi_trips_long_start_station_name (models/my_models/my_models.yml)
19:23:41    Got 910 results, configured to fail if != 0
19:23:41  
19:23:41    compiled code at target/compiled/dbt_book/models/my_models/my_models.yml/unique_citi_trips_long_start_station_name.sql
19:23:41  
19:23:41  Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
</code></pre>
<div class="float">
<img src="images/failed_test.png" alt="Failed test" />
<div class="figcaption">Failed test</div>
</div>
</div>
<div id="singular-tests-in-dbt" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Singular tests in dbt<a href="tests-1.html#singular-tests-in-dbt" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As mentioned earlier, singular tests are SQL models in your <code>tests</code> folder. They differ from the generic tests in that they are bespoke to your data needs. For example, if one of your tests doesn’t conform to the four batteries included tests, you can create one inside the <code>tests</code> folder.</p>
<p>Below we create a singular test called <code>unnecessary_trips.sql</code> inside the <code>test</code> folder. The purpose of the test is to raise an error if a trip is less than 1 min, and if this passes without a hitch, we increase the trip to 10 min. The latter must surely generate an error! Notice that one can reference another model within a test using the <code>ref()</code> function.</p>
<pre><code>SELECT bikeid, start_station_name, end_station_name,
    birth_year, gender, tripduration
FROM {{ ref(&#39;citi_trips_round&#39;) }}
WHERE trip_min_round &lt; 10
</code></pre>
<p>So to perform the litmus test, run our usual magic phrase:</p>
<pre><code>dbt test --select unnecessary_trips
</code></pre>
<p>Below will be the output.</p>
<pre><code>19:51:50  Concurrency: 1 threads (target=&#39;dev&#39;)
19:51:50  
19:51:50  1 of 1 START test unnecessary_trips ............................................ [RUN]
19:51:53  1 of 1 FAIL 25183763 unnecessary_trips ......................................... [FAIL 25183763 in 3.11s]
19:51:53  
19:51:53  Finished running 1 test in 0 hours 0 minutes and 4.70 seconds (4.70s).
19:51:53  
19:51:53  Completed with 1 error and 0 warnings:
19:51:53  
19:51:53  Failure in test unnecessary_trips (tests/unnecessary_trips.sql)
19:51:53    Got 25183763 results, configured to fail if != 0
19:51:53  
19:51:53    compiled code at target/compiled/dbt_book/tests/unnecessary_trips.sql
19:51:53  
19:51:53  Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1</code></pre>
<p>As you can see, a total 25183763 rows failed the test. If we had used a condition of less than 1 min (<code>trip_min_round &lt; 1</code>) the test would have passed.</p>
<p>A singular test can also be transformed into a generic test when its reused across the fields of your table(s) in the data warehouse. To demonstrate this, let’s create some generic tests.</p>
</div>
<div id="creating-a-generic-test" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> Creating a generic test<a href="tests-1.html#creating-a-generic-test" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>From the dbt documentation website, your <em>custom</em> generic tests are created within a <code>generic</code> folder within the <code>tests</code> directory. Thus, within your <code>tests/generic</code> directory, you will place the SQL models for your tests. Anything returned by your SQL models is in fact your tests failing! If nothing is returned, then your test passed, and your data as clean as a new pin.</p>
<p>Create a SQL model called <code>long_characters</code> within the <code>tests/generic</code> directory.</p>
<pre><code>{% test long_characters (model, column_name) %}
SELECT * FROM {{ model }}
WHERE LENGTH({{ column_name }}) &gt; 15 
{% endtest %}</code></pre>
<p>Let’s go through the above line by line. We begin a generic test by using the <code>{%test &lt;model-name&gt; (model, column_name) %}</code> SQL statement in here <code>{% endtest %}</code> tags. The <code>model</code> and <code>column_name</code> are standard arguments where one or both should be defined.</p>
<ul>
<li><p><code>model</code> - the resource on which the test will be operated on. In our case, this is any model in which the test will be run on.</p></li>
<li><p><code>column_name</code> - this is a field within which the model will be run against. In other words, the column at which this model will operate on.</p></li>
</ul>
<p>The SQL statement within the test tags references the model and the columns using the <code>{{ model }}</code> and <code>{{ column_name }}</code> respectively. For example, if the test is placed in the <code>my_models</code> YAML file under the <code>citi_trips_long</code> model name, for the field <code>start_station_name</code>, it is as though the test is running this SELECT statement:</p>
<pre><code>
SELECT * FROM citi_trips_long
WHERE LENGTH(start_station_name) &gt; 15 
</code></pre>
<p>In very few words, the above SQL tells dbt to shout out an error if any station name is greater than 15 characters. Such must be train stations larger than life.</p>
<p>Let’s create another test that will raise alarms if there are special characters within your <code>start_station_name</code>.</p>
<pre><code>{% test special_characters (model, column_name) %}
SELECT * FROM {{ model }}
WHERE {{ column_name }}
LIKE &#39;%^[a-zA-Z0-9+-]%&#39;
{% endtest %}
</code></pre>
<p>Okay, it’s not time for our litmus test. Going back to the <code>start_station_name</code> mapping that we have performed some litmus tests, lets also add our two <em>custom</em> generic tests of <code>long_character</code> and <code>special_characters</code>.</p>
<pre><code>- name: citi_trips_long
    description: &#39;{{ doc(&quot;citi_trips_long&quot;) }}&#39;
    columns:
      --snip--

      - name: start_station_name
        description: &quot;Start Station Name&quot;
        tests:
          - not_null
          - unique
          - long_characters
          - special_characters
</code></pre>
<p>If we go for the big bull and run all our tests with trusty <code>dbt test</code> keyword, we can see the output of the nine tests we have so far.</p>
<pre><code>19:08:15  Concurrency: 1 threads (target=&#39;dev&#39;)
19:08:15  
19:08:15  1 of 9 START test long_characters_citi_trips_long_start_station_name ........... [RUN]
19:08:29  1 of 9 FAIL 11463868 long_characters_citi_trips_long_start_station_name ........ [FAIL 11463868 in 14.47s]

--snip--

19:08:55  5 of 9 START test special_characters_citi_trips_long_start_station_name ........ [RUN]
19:08:59  5 of 9 PASS special_characters_citi_trips_long_start_station_name .............. [PASS in 4.48s]

--snip--

19:09:07  9 of 9 START test unnecessary_trips ............................................ [RUN]
19:09:10  9 of 9 FAIL 25183763 unnecessary_trips ......................................... [FAIL 25183763 in 2.81s]
</code></pre>
<p>From the above output, we can see that there were some station names with quite some long names and (thankfully) no station names with special characters.</p>
<p>There is also other output below the above which shows how many records failed, depending on your test.</p>
<pre><code>19:09:10  Completed with 4 errors and 0 warnings:
19:09:10  
19:09:10  Failure in test long_characters_citi_trips_long_start_station_name (models/my_models/my_models.yml)
19:09:10    Got 11463868 results, configured to fail if != 0
 
--snip--

19:09:10  Failure in test unique_citi_trips_long_start_station_name (models/my_models/my_models.yml)
19:09:10    Got 910 results, configured to fail if != 0
</code></pre>
</div>
<div id="configuring-custom-generic-tests" class="section level2 hasAnchor" number="9.5">
<h2><span class="header-section-number">9.5</span> Configuring custom generic tests<a href="tests-1.html#configuring-custom-generic-tests" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>What if you feel that the <em>FAIL</em> alert like in the above tests is shouting too much! That you would prefer them to be <em>WARNINGS</em> because they are non-critical?</p>
<p>You can do so by setting the configuration to diplay as a warning rather than an error.</p>
<pre><code>{% test long_characters (model, column_name) %}
    {{ config(severity = &#39;warn&#39;) }}
    SELECT * FROM {{ model }}
    WHERE LENGTH({{ column_name }}) &gt; 15 
{% endtest %}</code></pre>
<p>Here is the output as a warning.</p>
<pre><code>
19:16:34  1 of 9 START test long_characters_citi_trips_long_start_station_name ........... [RUN]
19:16:36  1 of 9 WARN 11463868 long_characters_citi_trips_long_start_station_name ........ [WARN 11463868 in 2.64s]
19:16:36  2 of 9 START test not_null_citi_trips_long_start_station_name .................. [RUN]
19:16:39  2 of 9 PASS not_null_citi_trips_long_start_station_name ........................ [PASS in 2.67s]
-- snip --
19:16:56  Warning in test long_characters_citi_trips_long_start_station_name (models/my_models/my_models.yml)
19:16:56  Got 11463868 results, configured to warn if != 0
-- snip --</code></pre>
<p>However, in case you immediately change your mind that the failing tests of <code>long_characters</code> returned should be an error rather than a warning, you can simply overide your custom generic SQL models by specifying the severity within the YAML definition files.</p>
<pre><code>- name: start_station_name
        description: &quot;Start Station Name&quot;
        tests:
          - not_null
          - unique
          - long_characters:
            severity: &#39;error&#39;
          - special_characters</code></pre>
<p>In the generated output, it will be back to business as usual with the ‘FAIL’ keyword.</p>
<pre><code>-- snip -- 
19:21:25  1 of 9 START test long_characters_citi_trips_long_start_station_name ........... [RUN]
19:21:28  1 of 9 FAIL 11463868 long_characters_citi_trips_long_start_station_name ........ [FAIL 11463868 in 3.45s]
-- snip --

19:21:50  Failure in test long_characters_citi_trips_long_start_station_name (models/my_models/my_models.yml)
19:21:50    Got 11463868 results, configured to fail if != 0
-- snip --
</code></pre>
</div>
<div id="storing-test-failures" class="section level2 hasAnchor" number="9.6">
<h2><span class="header-section-number">9.6</span> Storing test failures<a href="tests-1.html#storing-test-failures" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>If you thought that dbt tests are a cool feature, then there is one more trick in the bag if you want a neat one-liner to view a dataset of the failing records. The <em>open sesame</em> key word is <code>--store-failures</code>. dbt will store the failing records as a table in the database.</p>
<p>Let’s try it out. This is only what is needed to be run.</p>
<pre><code>dbt test --store-failures
</code></pre>
<p>Of course our test will generate failed records, but we’ve already seen them. Here is part of the output for the test of long characters above the 15 character threshold.</p>
<pre><code>19:26:40  Failure in test long_characters_citi_trips_long_start_station_name (models/my_models/my_models.yml)
19:26:40    Got 11463868 results, configured to fail if != 0
19:26:40  
19:26:40    compiled code at target/compiled/dbt_book/models/my_models/my_models.yml/long_characters_citi_trips_long_start_station_name.sql
19:26:40  
19:26:40    See test failures:
  -------------------------------------------------------------------------------------------------------------------
  select * from `dbt-project-437116`.`nyc_bikes_dbt_test__audit`.`long_characters_citi_trips_long_start_station_name`
  -------------------------------------------------------------------------------------------------------------------</code></pre>
<p>If you paste the <code>SELECT</code> statement in one of the SQL tabs for BigQuery, it will not only return the number of failing records but also the data that is part of the failing records.</p>
<div class="float">
<img src="images/failing_records.png" alt="Failing records" />
<div class="figcaption">Failing records</div>
</div>
<p>That’s a very convenient one-liner!</p>
<p>Below are other forms of generic tests shipped with dbt, for the <code>accepted_values</code> and <code>relationships</code>. The latter took to long to run and was cancelled midway.</p>
<pre><code>- name: end_station_name
        description: &quot;End Station Name&quot;
         tests:
            - relationships:
                to: ref(&#39;citi_trips_round&#39;)
                field: end_station_name

      - name: gender
        description: &quot;Gender (unknown, male, female)&quot;
        tests:
          - accepted_values:
              values: [&#39;unknown&#39;, &#39;male&#39;, &#39;female&#39;]
</code></pre>
<p>It’s been quite an exciting journey with tests. And for sure dbt tests do grill your data!</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="documentation-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="dbt-expectations-package.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/08-tests.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
