<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 17 Macros | dbt Book</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 17 Macros | dbt Book" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 17 Macros | dbt Book" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="Samuel Gachuhi Ngugi" />


<meta name="date" content="2024-11-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="jinja.html"/>
<link rel="next" href="hooks.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#usage"><i class="fa fa-check"></i><b>1.1</b> Usage</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#render-book"><i class="fa fa-check"></i><b>1.2</b> Render book</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#preview-book"><i class="fa fa-check"></i><b>1.3</b> Preview book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#what-is-dbt"><i class="fa fa-check"></i><b>2.1</b> What is dbt?</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#encounter-with-dbt"><i class="fa fa-check"></i><b>2.2</b> Encounter with <code>dbt</code></a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#dbt-from-the-professionals"><i class="fa fa-check"></i><b>2.3</b> dbt, from the professionals…</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#why-use-dbt"><i class="fa fa-check"></i><b>2.4</b> Why use dbt?</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html"><i class="fa fa-check"></i><b>3</b> The <code>dbt</code> architecture</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#models"><i class="fa fa-check"></i><b>3.0.1</b> Models</a></li>
<li class="chapter" data-level="3.0.2" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#tests"><i class="fa fa-check"></i><b>3.0.2</b> Tests</a></li>
<li class="chapter" data-level="3.0.3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#documentation"><i class="fa fa-check"></i><b>3.0.3</b> Documentation</a></li>
<li class="chapter" data-level="3.0.4" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#sources"><i class="fa fa-check"></i><b>3.0.4</b> Sources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-storage.html"><a href="data-storage.html"><i class="fa fa-check"></i><b>4</b> Data storage</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-storage.html"><a href="data-storage.html#data-warehouse"><i class="fa fa-check"></i><b>4.1</b> Data warehouse</a></li>
<li class="chapter" data-level="4.2" data-path="data-storage.html"><a href="data-storage.html#data-lake"><i class="fa fa-check"></i><b>4.2</b> Data lake</a></li>
<li class="chapter" data-level="4.3" data-path="data-storage.html"><a href="data-storage.html#data-lakehouse"><i class="fa fa-check"></i><b>4.3</b> Data lakehouse</a></li>
<li class="chapter" data-level="4.4" data-path="data-storage.html"><a href="data-storage.html#a-brief-history"><i class="fa fa-check"></i><b>4.4</b> A brief history</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html"><i class="fa fa-check"></i><b>5</b> Our data in BigQuery</a>
<ul>
<li class="chapter" data-level="5.1" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#accessing-big-query"><i class="fa fa-check"></i><b>5.1</b> Accessing Big Query</a></li>
<li class="chapter" data-level="5.2" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#copying-the-new-york-city-bikes-data"><i class="fa fa-check"></i><b>5.2</b> Copying the New York City Bikes data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="installing-dbt.html"><a href="installing-dbt.html"><i class="fa fa-check"></i><b>6</b> Installing dbt</a>
<ul>
<li class="chapter" data-level="6.1" data-path="installing-dbt.html"><a href="installing-dbt.html#setting-the-environment"><i class="fa fa-check"></i><b>6.1</b> Setting the environment</a></li>
<li class="chapter" data-level="6.2" data-path="installing-dbt.html"><a href="installing-dbt.html#connecting-to-your-bigquery-data-warehouse"><i class="fa fa-check"></i><b>6.2</b> Connecting to your BigQuery data warehouse</a></li>
<li class="chapter" data-level="6.3" data-path="installing-dbt.html"><a href="installing-dbt.html#initializing-a-dbt-project"><i class="fa fa-check"></i><b>6.3</b> Initializing a dbt project</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="models-1.html"><a href="models-1.html"><i class="fa fa-check"></i><b>7</b> Models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="models-1.html"><a href="models-1.html#running-a-model"><i class="fa fa-check"></i><b>7.1</b> Running a model</a></li>
<li class="chapter" data-level="7.2" data-path="models-1.html"><a href="models-1.html#model-structure"><i class="fa fa-check"></i><b>7.2</b> Model structure</a></li>
<li class="chapter" data-level="7.3" data-path="models-1.html"><a href="models-1.html#a-custom-model"><i class="fa fa-check"></i><b>7.3</b> A custom model</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="documentation-1.html"><a href="documentation-1.html"><i class="fa fa-check"></i><b>8</b> Documentation</a>
<ul>
<li class="chapter" data-level="8.1" data-path="documentation-1.html"><a href="documentation-1.html#the-yml-files"><i class="fa fa-check"></i><b>8.1</b> The yml files</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="documentation-1.html"><a href="documentation-1.html#version-2"><i class="fa fa-check"></i><b>8.1.1</b> <code>version: 2</code></a></li>
<li class="chapter" data-level="8.1.2" data-path="documentation-1.html"><a href="documentation-1.html#models-2"><i class="fa fa-check"></i><b>8.1.2</b> <code>models</code></a></li>
<li class="chapter" data-level="8.1.3" data-path="documentation-1.html"><a href="documentation-1.html#description"><i class="fa fa-check"></i><b>8.1.3</b> <code>description</code></a></li>
<li class="chapter" data-level="8.1.4" data-path="documentation-1.html"><a href="documentation-1.html#columns"><i class="fa fa-check"></i><b>8.1.4</b> <code>columns</code></a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="documentation-1.html"><a href="documentation-1.html#definition-for-our-model"><i class="fa fa-check"></i><b>8.2</b> Definition for our model</a></li>
<li class="chapter" data-level="8.3" data-path="documentation-1.html"><a href="documentation-1.html#using-the-doc-function"><i class="fa fa-check"></i><b>8.3</b> Using the <code>doc</code> function</a></li>
<li class="chapter" data-level="8.4" data-path="documentation-1.html"><a href="documentation-1.html#images-in-dbt-documentation"><i class="fa fa-check"></i><b>8.4</b> Images in dbt documentation</a></li>
<li class="chapter" data-level="8.5" data-path="documentation-1.html"><a href="documentation-1.html#generating-the-document"><i class="fa fa-check"></i><b>8.5</b> Generating the document</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="tests-1.html"><a href="tests-1.html"><i class="fa fa-check"></i><b>9</b> Tests</a>
<ul>
<li class="chapter" data-level="9.1" data-path="tests-1.html"><a href="tests-1.html#types-of-tests-in-dbt"><i class="fa fa-check"></i><b>9.1</b> Types of tests in dbt</a></li>
<li class="chapter" data-level="9.2" data-path="tests-1.html"><a href="tests-1.html#generic-tests-in-dbt"><i class="fa fa-check"></i><b>9.2</b> Generic tests in dbt</a></li>
<li class="chapter" data-level="9.3" data-path="tests-1.html"><a href="tests-1.html#singular-tests-in-dbt"><i class="fa fa-check"></i><b>9.3</b> Singular tests in dbt</a></li>
<li class="chapter" data-level="9.4" data-path="tests-1.html"><a href="tests-1.html#creating-a-generic-test"><i class="fa fa-check"></i><b>9.4</b> Creating a generic test</a></li>
<li class="chapter" data-level="9.5" data-path="tests-1.html"><a href="tests-1.html#configuring-custom-generic-tests"><i class="fa fa-check"></i><b>9.5</b> Configuring custom generic tests</a></li>
<li class="chapter" data-level="9.6" data-path="tests-1.html"><a href="tests-1.html#storing-test-failures"><i class="fa fa-check"></i><b>9.6</b> Storing test failures</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html"><i class="fa fa-check"></i><b>10</b> dbt Expectations package</a>
<ul>
<li class="chapter" data-level="10.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#dbt-expectations-installation"><i class="fa fa-check"></i><b>10.1</b> <code>dbt-expectations</code> installation</a></li>
<li class="chapter" data-level="10.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#types-of-dbt-expectations-tests"><i class="fa fa-check"></i><b>10.2</b> Types of <code>dbt-expectations</code> tests</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#table-shape"><i class="fa fa-check"></i><b>10.2.1</b> Table shape</a></li>
<li class="chapter" data-level="10.2.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#missing-values-unique-values-and-types"><i class="fa fa-check"></i><b>10.2.2</b> Missing values, unique values, and types</a></li>
<li class="chapter" data-level="10.2.3" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#sets-and-ranges"><i class="fa fa-check"></i><b>10.2.3</b> Sets and Ranges</a></li>
<li class="chapter" data-level="10.2.4" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#string-matching"><i class="fa fa-check"></i><b>10.2.4</b> String matching</a></li>
<li class="chapter" data-level="10.2.5" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#aggregate"><i class="fa fa-check"></i><b>10.2.5</b> Aggregate</a></li>
<li class="chapter" data-level="10.2.6" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#multi-column"><i class="fa fa-check"></i><b>10.2.6</b> Multi-column</a></li>
<li class="chapter" data-level="10.2.7" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#distributional-functions"><i class="fa fa-check"></i><b>10.2.7</b> Distributional functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="seeds.html"><a href="seeds.html"><i class="fa fa-check"></i><b>11</b> Seeds</a>
<ul>
<li class="chapter" data-level="11.1" data-path="seeds.html"><a href="seeds.html#uploading-a-seed-into-your-data-warehouse"><i class="fa fa-check"></i><b>11.1</b> Uploading a seed into your data warehouse</a></li>
<li class="chapter" data-level="11.2" data-path="seeds.html"><a href="seeds.html#referencing-seeds-in-models"><i class="fa fa-check"></i><b>11.2</b> Referencing seeds in models</a></li>
<li class="chapter" data-level="11.3" data-path="seeds.html"><a href="seeds.html#seed-configurations-at-project-level"><i class="fa fa-check"></i><b>11.3</b> Seed Configurations at project level</a></li>
<li class="chapter" data-level="11.4" data-path="seeds.html"><a href="seeds.html#seed-properties-and-configurations-at-properties-level"><i class="fa fa-check"></i><b>11.4</b> Seed properties and configurations at properties level</a></li>
<li class="chapter" data-level="11.5" data-path="seeds.html"><a href="seeds.html#performing-tests-on-seeds"><i class="fa fa-check"></i><b>11.5</b> Performing tests on seeds</a></li>
<li class="chapter" data-level="11.6" data-path="seeds.html"><a href="seeds.html#viewing-documentation-for-dbt-seeds"><i class="fa fa-check"></i><b>11.6</b> Viewing documentation for dbt seeds</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="sources-1.html"><a href="sources-1.html"><i class="fa fa-check"></i><b>12</b> Sources</a>
<ul>
<li class="chapter" data-level="12.1" data-path="sources-1.html"><a href="sources-1.html#defining-a-source"><i class="fa fa-check"></i><b>12.1</b> Defining a source</a></li>
<li class="chapter" data-level="12.2" data-path="sources-1.html"><a href="sources-1.html#referencing-sources"><i class="fa fa-check"></i><b>12.2</b> Referencing sources</a></li>
<li class="chapter" data-level="12.3" data-path="sources-1.html"><a href="sources-1.html#defining-properties-in-a-sources-file"><i class="fa fa-check"></i><b>12.3</b> Defining properties in a <code>sources</code> file</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="snapshots.html"><a href="snapshots.html"><i class="fa fa-check"></i><b>13</b> Snapshots</a>
<ul>
<li class="chapter" data-level="13.1" data-path="snapshots.html"><a href="snapshots.html#create-a-snapshot"><i class="fa fa-check"></i><b>13.1</b> Create a snapshot</a></li>
<li class="chapter" data-level="13.2" data-path="snapshots.html"><a href="snapshots.html#the-check-strategy"><i class="fa fa-check"></i><b>13.2</b> The <code>check</code> strategy</a></li>
<li class="chapter" data-level="13.3" data-path="snapshots.html"><a href="snapshots.html#the-timestamp-strategy"><i class="fa fa-check"></i><b>13.3</b> The <code>timestamp</code> strategy</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="analyses.html"><a href="analyses.html"><i class="fa fa-check"></i><b>14</b> Analyses</a>
<ul>
<li class="chapter" data-level="14.1" data-path="analyses.html"><a href="analyses.html#creating-an-analysis"><i class="fa fa-check"></i><b>14.1</b> Creating an <code>analysis</code></a></li>
<li class="chapter" data-level="14.2" data-path="analyses.html"><a href="analyses.html#definitions-for-analyses"><i class="fa fa-check"></i><b>14.2</b> Definitions for <code>analyses</code></a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="exposures.html"><a href="exposures.html"><i class="fa fa-check"></i><b>15</b> Exposures</a>
<ul>
<li class="chapter" data-level="15.1" data-path="exposures.html"><a href="exposures.html#creating-an-exposure"><i class="fa fa-check"></i><b>15.1</b> Creating an exposure</a></li>
<li class="chapter" data-level="15.2" data-path="exposures.html"><a href="exposures.html#visualizing-the-exposure"><i class="fa fa-check"></i><b>15.2</b> Visualizing the exposure</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="jinja.html"><a href="jinja.html"><i class="fa fa-check"></i><b>16</b> Jinja</a>
<ul>
<li class="chapter" data-level="16.1" data-path="jinja.html"><a href="jinja.html#a-simple-jinja-statement"><i class="fa fa-check"></i><b>16.1</b> A simple jinja statement</a></li>
<li class="chapter" data-level="16.2" data-path="jinja.html"><a href="jinja.html#a-more-complex-jinja-query"><i class="fa fa-check"></i><b>16.2</b> A more complex jinja query</a></li>
<li class="chapter" data-level="16.3" data-path="jinja.html"><a href="jinja.html#improvising-using-dry-principle"><i class="fa fa-check"></i><b>16.3</b> Improvising using DRY Principle</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="macros.html"><a href="macros.html"><i class="fa fa-check"></i><b>17</b> Macros</a>
<ul>
<li class="chapter" data-level="17.1" data-path="macros.html"><a href="macros.html#invoking-a-macro"><i class="fa fa-check"></i><b>17.1</b> Invoking a macro</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="macros.html"><a href="macros.html#invoking-a-macro-using-expression-blocks"><i class="fa fa-check"></i><b>17.1.1</b> Invoking a macro using expression blocks</a></li>
<li class="chapter" data-level="17.1.2" data-path="macros.html"><a href="macros.html#invoke-a-macro-using-call-blocks"><i class="fa fa-check"></i><b>17.1.2</b> Invoke a macro using call blocks</a></li>
<li class="chapter" data-level="17.1.3" data-path="macros.html"><a href="macros.html#invoke-a-macro-from-the-command-line-interface-cli"><i class="fa fa-check"></i><b>17.1.3</b> Invoke a macro from the Command Line Interface (CLI)</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="macros.html"><a href="macros.html#simple-macro"><i class="fa fa-check"></i><b>17.2</b> Simple macro</a></li>
<li class="chapter" data-level="17.3" data-path="macros.html"><a href="macros.html#complex-macro"><i class="fa fa-check"></i><b>17.3</b> Complex macro</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="hooks.html"><a href="hooks.html"><i class="fa fa-check"></i><b>18</b> Hooks</a>
<ul>
<li class="chapter" data-level="18.1" data-path="hooks.html"><a href="hooks.html#post-hooks"><i class="fa fa-check"></i><b>18.1</b> Post-hooks</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">dbt Book</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="macros" class="section level1 hasAnchor" number="17">
<h1><span class="header-section-number">Chapter 17</span> Macros<a href="macros.html#macros" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>A <a href="https://www.phdata.io/blog/what-are-dbt-macros/?utm_source=pocket_saves">macro</a> in dbt is a reusable piece of code. That’s it. A macro in dbt is what a function is to Python or JavaScript. The building block of a macro is the jinja template. Below is the structure of a dbt macro.</p>
<pre><code>{% macro macro_name(arg1, arg2, ..., argN) %}

    SQL logic here, using the parameters as needed.

{% endmacro %}
</code></pre>
<p>You begin a macro with the name <code>macro</code> and end it with <code>endmacro</code>. Macros are defined in SQL files and stored inside the already shipped <code>macros</code> folder in dbt.</p>
<div id="invoking-a-macro" class="section level2 hasAnchor" number="17.1">
<h2><span class="header-section-number">17.1</span> Invoking a macro<a href="macros.html#invoking-a-macro" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are three ways to call a macro. They are:</p>
<ol style="list-style-type: decimal">
<li><p>Using expression blocks</p></li>
<li><p>Call blocks</p></li>
<li><p>Run operation command</p></li>
</ol>
<div id="invoking-a-macro-using-expression-blocks" class="section level3 hasAnchor" number="17.1.1">
<h3><span class="header-section-number">17.1.1</span> Invoking a macro using expression blocks<a href="macros.html#invoking-a-macro-using-expression-blocks" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If the macro does not have any parameters, it can be invoked as a solo object like so:</p>
<pre><code>{{ macro_name() }}
</code></pre>
<p>But if it has parameters, we have to call it with it’s entire entourage.</p>
<pre><code>{{ macro_name(arg1, arg2, argN) }}
</code></pre>
</div>
<div id="invoke-a-macro-using-call-blocks" class="section level3 hasAnchor" number="17.1.2">
<h3><span class="header-section-number">17.1.2</span> Invoke a macro using call blocks<a href="macros.html#invoke-a-macro-using-call-blocks" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this method, one can invoke a macro inside another macro. Here is the template.</p>
<pre><code>{% call called_macro( arg1, arg2, . . argN) %}

    Code to be accessed by the macro called_macro

{% endcall %}
</code></pre>
<p>The above code calls a macro called <code>called_macro</code> and everything in between the <code>{ %call% }</code> and <code>{% endcall %}</code> statements can be accessed using the <code>caller()</code> method.</p>
<p>Here is an example of a macro.</p>
<pre><code>{% macro select_all_columns_macro(table_name) %}

    SELECT *
    FROM {{ table_name }}
    WHERE {{ caller() }}

{% endmacro %}
</code></pre>
<p>Now, call the macro using call blocks.</p>
<pre><code>{% call select_all_columns_macro(&#39;EVENT_TABLE&#39;) %}

CREATE_DATE &gt;= &#39;2020-02-18&#39;::DATE

{%- endcall %}
</code></pre>
<p>When it is called it would render:</p>
<pre><code>SELECT *
FROM EVENT_TABLE
WHERE CREATE_DATE &gt;= &#39;2020-02-18&#39;::DATE</code></pre>
</div>
<div id="invoke-a-macro-from-the-command-line-interface-cli" class="section level3 hasAnchor" number="17.1.3">
<h3><span class="header-section-number">17.1.3</span> Invoke a macro from the Command Line Interface (CLI)<a href="macros.html#invoke-a-macro-from-the-command-line-interface-cli" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To run a macro from the CLI or terminal, we use the <code>dbt run-operation {macro} --args '{args}'{macro}:</code> command. The macro will run with the arguments provided. The below macro being run from the CLI selects all columns from a table called <code>my_table</code>.</p>
<pre><code>dbt run-operation select_all_columns --args &#39;{table_name: my_table}&#39;
</code></pre>
<p>The above are ways to invoke a macro but for simplicity purposes, for life is too complicated to add more complications from something miniature as macros, we shall rely on the first method of invoking macros using expressions.</p>
</div>
</div>
<div id="simple-macro" class="section level2 hasAnchor" number="17.2">
<h2><span class="header-section-number">17.2</span> Simple macro<a href="macros.html#simple-macro" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Having known that a macro acts like a function, let’s create a macro that calculates the age of a bike rider. We already have the <code>birth_year</code> column, so getting age should just be subtracting birth year from the current year.</p>
<p>As earlier mentioned, macros should go into the <code>macros</code> folder. Create a <code>calculate_age</code> SQL file and inside it paste the following contents.</p>
<pre><code>{% macro calculate_age (year) %}

(EXTRACT( YEAR FROM CURRENT_DATE() ) - {{ year }}) 

{% endmacro %}</code></pre>
<p>Remember, a macro is a function and thus what goes within the <code>{% macro %}</code> and <code>{% endmacro %}</code> expressions is the function itself! This explains why our <code>calculate_age</code> macro is so succinct. The <code>(EXTRACT( YEAR FROM CURRENT_DATE() ) - {{ year }})</code> is just an SQL way of subtracting any column, referenced by the variable <code>{{ year }}</code> from the current year. Of course the <code>{{ year }}</code> column specified has to be numeric.</p>
<p>Alright. To see the <code>calculate_age</code> macro in action, create a <code>biker_age</code> SQL file inside the <code>jinja</code> directory. Paste the following content.</p>
<pre><code>SELECT *, 
{{ calculate_age(&quot;birth_year&quot;)}} AS AGE
FROM 
{{ ref(&#39;citi_trips_long&#39;) }}
</code></pre>
<p>In the subchapter of <a href="#id_#Invoking%20a%20macro">Invoking a Macro</a> we saw that we invoke a macro in the following format: <code>{{ macro_name(arg1, arg2, argN) }}</code>. The macro name goes first, followed by the arguments in brackets. We have essentially done this in the <code>biker_age</code> SQL file. The <code>calclate_age()</code> macro has been provided the column to calculate on, obviously the <code>birth_year</code> column. We use the <code>AS</code> keyword to create a new column with the alias <code>AGE</code>. Thereafter, we run the open sesame command <code>dbt compile --select macros</code>.</p>
<p>We got the following in the target directory, a <code>biker_age</code> SQL file with the following SELECT query:</p>
<pre><code>SELECT *, 


(EXTRACT( YEAR FROM CURRENT_DATE() ) - birth_year) 

 AS AGE
FROM 
`dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
</code></pre>
<p>The above should definitely result in a table with the <code>AGE</code> column at the far end.</p>
</div>
<div id="complex-macro" class="section level2 hasAnchor" number="17.3">
<h2><span class="header-section-number">17.3</span> Complex macro<a href="macros.html#complex-macro" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The above was a simple macro that neatly drove the point home. How about a more complex macro, like one that works on an entire table, transforms it, has more than one argument and oh, one in which you can change the arguments? We are trying to work with a function where we cast things on sand, and not stone. That’s the kind of macro we need. Create a SQL called <code>age_trips</code> with the following code:</p>
<pre><code>{% macro age_trips (column, duration, table_name, years = [1995, 1997, 2002]) %}

SELECT {{ column }}, 
SUM({{ duration }}) AS totals_trip_min_round
FROM {{ ref( table_name ) }}
WHERE {{ column }} IN (
  {% for year in years %}
  {# this will separate the years 1995, 1997 and 2002 with a comma, nothing out of this world #}
    {{ year }}{% if not loop.last %}, {% endif %}
  {% endfor %}
)
GROUP BY {{ column }}
ORDER BY {{ column }} DESC

{% endmacro %}</code></pre>
<p>Our intelligent mind (no pun intended) created a macro that selects a column, sums the time duration in that column but aggregates the sum based on certain numerical column values. It will not sum everything in the entire set but for certain values specified by the <code>years</code> variable. Additionally, we have preset the values to go into the <code>years</code> variables which are <code>1995</code>, <code>1997</code> and <code>2002</code>. Finally, to finish in a clean manner, we order the table based on arranging the specified column values in descending order.</p>
<p>Now is time to test our macro. Under the <code>jinja</code> directory, create a SQL file called <code>age_trip_totals</code>. It should have the below miniatuae code.</p>
<pre><code>{{ age_trips(column=&#39;birth_year&#39;, duration=&#39;trip_min_round&#39;,
table_name=&#39;citi_trips_long&#39;, years = [1990, 1996, 1998, 2001, 2002]) }}</code></pre>
<p>What on earth just happened here? There was no <code>SELECT</code> statement as in the <code>biker_age</code> file? Yes, there wasn’t, and for the good reason in that we specifed our <code>SELECT</code> blueprint in the macros file, such that calling the <code>age_trips</code> function from within <code>age_trips_totals</code> file will invoke the SQL statement encapsulated by the <code>age_trips</code> function. If you run <code>dbt compile --select macros</code> the following SQL file will be compiled in the target directory.</p>
<pre><code>SELECT birth_year, 
SUM(trip_min_round) AS totals_trip_min_round
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
WHERE birth_year IN (
  
  
    1990, 
  
  
    1996, 
  
  
    1998, 
  
  
    2001, 
  
  
    2002
  
)
GROUP BY birth_year
ORDER BY birth_year DESC
</code></pre>
<p>Pasting this query on BigQuery will give us a table with the total trip duration for all bikers aggregated into specific years: 1990, 1996, 1998, 2001 and 2002.</p>
<p><img src="images/age_trip.png" alt="Age trip table" />
One can also create a view of this macro model using <code>dbt run --select age_trip_totals</code>. A <code>biker_age</code> view should appear under the <code>nyc_bikes</code> dataset.</p>
<p>By doing the above, we not only created a macros with default parameters, but we could also change them and get valid results as seen when playing around with the <code>years</code> argument in our <code>age_trips()</code> function. As a matter of fact, the <code>years</code> parameter doesn’t have to take <em>years</em> per se, it can actually work with any numerical column. But we just specified the name <code>years</code> as a clue. In the <code>age_trip_totals2</code> SQL file, we specified the ages of interest from within the <code>AGE</code> column of our <code>biker_age</code> view.</p>
<pre><code>{{ age_trips(column=&#39;AGE&#39;, duration=&#39;trip_min_round&#39;,
table_name=&#39;biker_age&#39;, years = [22, 27, 29]) }}</code></pre>
<p>Now let’s compile this model and see the result:</p>
<pre><code>dbt compile --select age_trip_totals2</code></pre>
<p>We get the following output in our terminal and by extension, the <code>age_trip_totals2</code> SQL file under the <code>target</code> directory.</p>
<pre><code>19:53:44  Concurrency: 1 threads (target=&#39;dev&#39;)
19:53:44  
19:53:44  Compiled node &#39;age_trip_totals2&#39; is:


SELECT AGE, 
SUM(trip_min_round) AS totals_trip_min_round
FROM `dbt-project-437116`.`nyc_bikes`.`biker_age`
WHERE AGE IN (
  
  
    22, 
  
  
    27, 
  
  
    29
  
)
GROUP BY AGE
ORDER BY AGE DESC
</code></pre>
<p>Pasting the above in BigQuery gives us an aggregation of the total trip duration for people aged 29, 27 and 22.</p>
<div class="float">
<img src="images/age_trip_totals2.png" alt="Age trip total 2 view" />
<div class="figcaption">Age trip total 2 view</div>
</div>
<p>As mentioned earlier, and as show with a quick example of <code>age_trip_totals</code> model, we can create views of each of our macro reliant models. Since they are all within the jinja directory, the following does the trick: <code>dbt run --select jinja</code>. This should create a view of each of our models created in this chapter.</p>
<p>Below is a snippet of the creation of views.</p>
<pre><code>-- snip --
20:15:05  8 of 8 START sql view model nyc_bikes.age_trip_totals2 ......................... [RUN]
20:15:07  8 of 8 OK created sql view model nyc_bikes.age_trip_totals2 .................... [CREATE VIEW (0 processed) in 2.28s]
-- snip --</code></pre>
<div class="float">
<img src="images/macro_reliant.png" alt="All macro reliant models" />
<div class="figcaption">All macro reliant models</div>
</div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="jinja.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="hooks.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/16-macros.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
