<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 16 Jinja | dbt Book</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 16 Jinja | dbt Book" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 16 Jinja | dbt Book" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="Samuel Gachuhi Ngugi" />


<meta name="date" content="2024-11-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="exposures.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#usage"><i class="fa fa-check"></i><b>1.1</b> Usage</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#render-book"><i class="fa fa-check"></i><b>1.2</b> Render book</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#preview-book"><i class="fa fa-check"></i><b>1.3</b> Preview book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#what-is-dbt"><i class="fa fa-check"></i><b>2.1</b> What is dbt?</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#encounter-with-dbt"><i class="fa fa-check"></i><b>2.2</b> Encounter with <code>dbt</code></a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#dbt-from-the-professionals"><i class="fa fa-check"></i><b>2.3</b> dbt, from the professionals…</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#why-use-dbt"><i class="fa fa-check"></i><b>2.4</b> Why use dbt?</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html"><i class="fa fa-check"></i><b>3</b> The <code>dbt</code> architecture</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#models"><i class="fa fa-check"></i><b>3.0.1</b> Models</a></li>
<li class="chapter" data-level="3.0.2" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#tests"><i class="fa fa-check"></i><b>3.0.2</b> Tests</a></li>
<li class="chapter" data-level="3.0.3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#documentation"><i class="fa fa-check"></i><b>3.0.3</b> Documentation</a></li>
<li class="chapter" data-level="3.0.4" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#sources"><i class="fa fa-check"></i><b>3.0.4</b> Sources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-storage.html"><a href="data-storage.html"><i class="fa fa-check"></i><b>4</b> Data storage</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-storage.html"><a href="data-storage.html#data-warehouse"><i class="fa fa-check"></i><b>4.1</b> Data warehouse</a></li>
<li class="chapter" data-level="4.2" data-path="data-storage.html"><a href="data-storage.html#data-lake"><i class="fa fa-check"></i><b>4.2</b> Data lake</a></li>
<li class="chapter" data-level="4.3" data-path="data-storage.html"><a href="data-storage.html#data-lakehouse"><i class="fa fa-check"></i><b>4.3</b> Data lakehouse</a></li>
<li class="chapter" data-level="4.4" data-path="data-storage.html"><a href="data-storage.html#a-brief-history"><i class="fa fa-check"></i><b>4.4</b> A brief history</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html"><i class="fa fa-check"></i><b>5</b> Our data in BigQuery</a>
<ul>
<li class="chapter" data-level="5.1" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#accessing-big-query"><i class="fa fa-check"></i><b>5.1</b> Accessing Big Query</a></li>
<li class="chapter" data-level="5.2" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#copying-the-new-york-city-bikes-data"><i class="fa fa-check"></i><b>5.2</b> Copying the New York City Bikes data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="installing-dbt.html"><a href="installing-dbt.html"><i class="fa fa-check"></i><b>6</b> Installing dbt</a>
<ul>
<li class="chapter" data-level="6.1" data-path="installing-dbt.html"><a href="installing-dbt.html#setting-the-environment"><i class="fa fa-check"></i><b>6.1</b> Setting the environment</a></li>
<li class="chapter" data-level="6.2" data-path="installing-dbt.html"><a href="installing-dbt.html#connecting-to-your-bigquery-data-warehouse"><i class="fa fa-check"></i><b>6.2</b> Connecting to your BigQuery data warehouse</a></li>
<li class="chapter" data-level="6.3" data-path="installing-dbt.html"><a href="installing-dbt.html#initializing-a-dbt-project"><i class="fa fa-check"></i><b>6.3</b> Initializing a dbt project</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="models-1.html"><a href="models-1.html"><i class="fa fa-check"></i><b>7</b> Models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="models-1.html"><a href="models-1.html#running-a-model"><i class="fa fa-check"></i><b>7.1</b> Running a model</a></li>
<li class="chapter" data-level="7.2" data-path="models-1.html"><a href="models-1.html#model-structure"><i class="fa fa-check"></i><b>7.2</b> Model structure</a></li>
<li class="chapter" data-level="7.3" data-path="models-1.html"><a href="models-1.html#a-custom-model"><i class="fa fa-check"></i><b>7.3</b> A custom model</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="documentation-1.html"><a href="documentation-1.html"><i class="fa fa-check"></i><b>8</b> Documentation</a>
<ul>
<li class="chapter" data-level="8.1" data-path="documentation-1.html"><a href="documentation-1.html#the-yml-files"><i class="fa fa-check"></i><b>8.1</b> The yml files</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="documentation-1.html"><a href="documentation-1.html#version-2"><i class="fa fa-check"></i><b>8.1.1</b> <code>version: 2</code></a></li>
<li class="chapter" data-level="8.1.2" data-path="documentation-1.html"><a href="documentation-1.html#models-2"><i class="fa fa-check"></i><b>8.1.2</b> <code>models</code></a></li>
<li class="chapter" data-level="8.1.3" data-path="documentation-1.html"><a href="documentation-1.html#description"><i class="fa fa-check"></i><b>8.1.3</b> <code>description</code></a></li>
<li class="chapter" data-level="8.1.4" data-path="documentation-1.html"><a href="documentation-1.html#columns"><i class="fa fa-check"></i><b>8.1.4</b> <code>columns</code></a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="documentation-1.html"><a href="documentation-1.html#definition-for-our-model"><i class="fa fa-check"></i><b>8.2</b> Definition for our model</a></li>
<li class="chapter" data-level="8.3" data-path="documentation-1.html"><a href="documentation-1.html#using-the-doc-function"><i class="fa fa-check"></i><b>8.3</b> Using the <code>doc</code> function</a></li>
<li class="chapter" data-level="8.4" data-path="documentation-1.html"><a href="documentation-1.html#images-in-dbt-documentation"><i class="fa fa-check"></i><b>8.4</b> Images in dbt documentation</a></li>
<li class="chapter" data-level="8.5" data-path="documentation-1.html"><a href="documentation-1.html#generating-the-document"><i class="fa fa-check"></i><b>8.5</b> Generating the document</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="tests-1.html"><a href="tests-1.html"><i class="fa fa-check"></i><b>9</b> Tests</a>
<ul>
<li class="chapter" data-level="9.1" data-path="tests-1.html"><a href="tests-1.html#types-of-tests-in-dbt"><i class="fa fa-check"></i><b>9.1</b> Types of tests in dbt</a></li>
<li class="chapter" data-level="9.2" data-path="tests-1.html"><a href="tests-1.html#generic-tests-in-dbt"><i class="fa fa-check"></i><b>9.2</b> Generic tests in dbt</a></li>
<li class="chapter" data-level="9.3" data-path="tests-1.html"><a href="tests-1.html#singular-tests-in-dbt"><i class="fa fa-check"></i><b>9.3</b> Singular tests in dbt</a></li>
<li class="chapter" data-level="9.4" data-path="tests-1.html"><a href="tests-1.html#creating-a-generic-test"><i class="fa fa-check"></i><b>9.4</b> Creating a generic test</a></li>
<li class="chapter" data-level="9.5" data-path="tests-1.html"><a href="tests-1.html#configuring-custom-generic-tests"><i class="fa fa-check"></i><b>9.5</b> Configuring custom generic tests</a></li>
<li class="chapter" data-level="9.6" data-path="tests-1.html"><a href="tests-1.html#storing-test-failures"><i class="fa fa-check"></i><b>9.6</b> Storing test failures</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html"><i class="fa fa-check"></i><b>10</b> dbt Expectations package</a>
<ul>
<li class="chapter" data-level="10.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#dbt-expectations-installation"><i class="fa fa-check"></i><b>10.1</b> <code>dbt-expectations</code> installation</a></li>
<li class="chapter" data-level="10.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#types-of-dbt-expectations-tests"><i class="fa fa-check"></i><b>10.2</b> Types of <code>dbt-expectations</code> tests</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#table-shape"><i class="fa fa-check"></i><b>10.2.1</b> Table shape</a></li>
<li class="chapter" data-level="10.2.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#missing-values-unique-values-and-types"><i class="fa fa-check"></i><b>10.2.2</b> Missing values, unique values, and types</a></li>
<li class="chapter" data-level="10.2.3" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#sets-and-ranges"><i class="fa fa-check"></i><b>10.2.3</b> Sets and Ranges</a></li>
<li class="chapter" data-level="10.2.4" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#string-matching"><i class="fa fa-check"></i><b>10.2.4</b> String matching</a></li>
<li class="chapter" data-level="10.2.5" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#aggregate"><i class="fa fa-check"></i><b>10.2.5</b> Aggregate</a></li>
<li class="chapter" data-level="10.2.6" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#multi-column"><i class="fa fa-check"></i><b>10.2.6</b> Multi-column</a></li>
<li class="chapter" data-level="10.2.7" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#distributional-functions"><i class="fa fa-check"></i><b>10.2.7</b> Distributional functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="seeds.html"><a href="seeds.html"><i class="fa fa-check"></i><b>11</b> Seeds</a>
<ul>
<li class="chapter" data-level="11.1" data-path="seeds.html"><a href="seeds.html#uploading-a-seed-into-your-data-warehouse"><i class="fa fa-check"></i><b>11.1</b> Uploading a seed into your data warehouse</a></li>
<li class="chapter" data-level="11.2" data-path="seeds.html"><a href="seeds.html#referencing-seeds-in-models"><i class="fa fa-check"></i><b>11.2</b> Referencing seeds in models</a></li>
<li class="chapter" data-level="11.3" data-path="seeds.html"><a href="seeds.html#seed-configurations-at-project-level"><i class="fa fa-check"></i><b>11.3</b> Seed Configurations at project level</a></li>
<li class="chapter" data-level="11.4" data-path="seeds.html"><a href="seeds.html#seed-properties-and-configurations-at-properties-level"><i class="fa fa-check"></i><b>11.4</b> Seed properties and configurations at properties level</a></li>
<li class="chapter" data-level="11.5" data-path="seeds.html"><a href="seeds.html#performing-tests-on-seeds"><i class="fa fa-check"></i><b>11.5</b> Performing tests on seeds</a></li>
<li class="chapter" data-level="11.6" data-path="seeds.html"><a href="seeds.html#viewing-documentation-for-dbt-seeds"><i class="fa fa-check"></i><b>11.6</b> Viewing documentation for dbt seeds</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="sources-1.html"><a href="sources-1.html"><i class="fa fa-check"></i><b>12</b> Sources</a>
<ul>
<li class="chapter" data-level="12.1" data-path="sources-1.html"><a href="sources-1.html#defining-a-source"><i class="fa fa-check"></i><b>12.1</b> Defining a source</a></li>
<li class="chapter" data-level="12.2" data-path="sources-1.html"><a href="sources-1.html#referencing-sources"><i class="fa fa-check"></i><b>12.2</b> Referencing sources</a></li>
<li class="chapter" data-level="12.3" data-path="sources-1.html"><a href="sources-1.html#defining-properties-in-a-sources-file"><i class="fa fa-check"></i><b>12.3</b> Defining properties in a <code>sources</code> file</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="snapshots.html"><a href="snapshots.html"><i class="fa fa-check"></i><b>13</b> Snapshots</a>
<ul>
<li class="chapter" data-level="13.1" data-path="snapshots.html"><a href="snapshots.html#create-a-snapshot"><i class="fa fa-check"></i><b>13.1</b> Create a snapshot</a></li>
<li class="chapter" data-level="13.2" data-path="snapshots.html"><a href="snapshots.html#the-check-strategy"><i class="fa fa-check"></i><b>13.2</b> The <code>check</code> strategy</a></li>
<li class="chapter" data-level="13.3" data-path="snapshots.html"><a href="snapshots.html#the-timestamp-strategy"><i class="fa fa-check"></i><b>13.3</b> The <code>timestamp</code> strategy</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="analyses.html"><a href="analyses.html"><i class="fa fa-check"></i><b>14</b> Analyses</a>
<ul>
<li class="chapter" data-level="14.1" data-path="analyses.html"><a href="analyses.html#creating-an-analysis"><i class="fa fa-check"></i><b>14.1</b> Creating an <code>analysis</code></a></li>
<li class="chapter" data-level="14.2" data-path="analyses.html"><a href="analyses.html#definitions-for-analyses"><i class="fa fa-check"></i><b>14.2</b> Definitions for <code>analyses</code></a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="exposures.html"><a href="exposures.html"><i class="fa fa-check"></i><b>15</b> Exposures</a>
<ul>
<li class="chapter" data-level="15.1" data-path="exposures.html"><a href="exposures.html#creating-an-exposure"><i class="fa fa-check"></i><b>15.1</b> Creating an exposure</a></li>
<li class="chapter" data-level="15.2" data-path="exposures.html"><a href="exposures.html#visualizing-the-exposure"><i class="fa fa-check"></i><b>15.2</b> Visualizing the exposure</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="jinja.html"><a href="jinja.html"><i class="fa fa-check"></i><b>16</b> Jinja</a>
<ul>
<li class="chapter" data-level="16.1" data-path="jinja.html"><a href="jinja.html#a-simple-jinja-statement"><i class="fa fa-check"></i><b>16.1</b> A simple jinja statement</a></li>
<li class="chapter" data-level="16.2" data-path="jinja.html"><a href="jinja.html#a-more-complex-jinja-query"><i class="fa fa-check"></i><b>16.2</b> A more complex jinja query</a></li>
<li class="chapter" data-level="16.3" data-path="jinja.html"><a href="jinja.html#improvising-using-dry-principle"><i class="fa fa-check"></i><b>16.3</b> Improvising using DRY Principle</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">dbt Book</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="jinja" class="section level1 hasAnchor" number="16">
<h1><span class="header-section-number">Chapter 16</span> Jinja<a href="jinja.html#jinja" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><a href="https://docs.getdbt.com/docs/build/jinja-macros">Jinja</a> in dbt is used to perform functions that regular SQL is unable to do, such as iterating over columns using a <code>for</code> loop and also <code>if</code> statements. Jinja is also used to hold environment variables which can be (re)used all over your project. A simple example of jinja use in dbt is when calling the <code>ref()</code> function. If you see anything with double curly brackets (<code>{{ }}</code>) or with brackets and percentage sign(s) in them (<code>{% %}</code>) then you are dealing with jinja.</p>
<p>Let’s start by explaining some jinja concepts.</p>
<ul>
<li><p><strong>Expressions {{ … }}</strong>: Expressions are used when you want to output a string. You can use expressions to reference variables and call macros.</p></li>
<li><p><strong>Statements {% … %}</strong>: Statements don’t output a string. They are used for control flow, for example, to set up for loops and if statements, to set or modify variables, or to define macros.</p></li>
<li><p><strong>Comments {# … #}</strong>: Jinja comments are used to prevent the text within the comment from executing or outputing a string. Don’t use – for comment.</p></li>
</ul>
<p>To make the point sink home since jinja can at time look mind boggling to the novice beginner, we’ll start with explaining a for loop. This is the skeleton of a <code>for</code> loop in jinja.</p>
<pre><code>{% for item in sequence %}
-- SQL Code for {{ item }}
{% endfor %}
</code></pre>
<div id="a-simple-jinja-statement" class="section level2 hasAnchor" number="16.1">
<h2><span class="header-section-number">16.1</span> A simple jinja statement<a href="jinja.html#a-simple-jinja-statement" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Going by the above cue, let’s create a jinja statement that will select all those rows whose bike riders’ birth years are any of the following: 1995, 1997 and 2002. Nothing special about these years, just that they stem from the unprofitable notion that they correspond to my birth year and those of my siblings!</p>
<p>Create a new folder called <code>jinja</code> under the <code>models</code> directory and within it create a <code>years</code> SQL file. Copy past the following contents into <code>years.sql</code>.</p>
<pre><code>{% set years = [1995, 1997, 2002] %}

{% for year in years %}
SELECT * 
FROM {{ ref(&#39;citi_trips_long&#39;) }}
WHERE birth_year = {{ year }}


{% endfor %}
</code></pre>
<p>Let’s go through the above line by line. It may look a bit more cryptic that the go lucky SQL statements we write, but it is quite easy, especially if you know a bit of python.</p>
<ul>
<li><p><code>{% set years = [1995, 1997, 2002] %}</code> - this sets the variables we will use to extract some data from our tables. The <code>years</code> variable consists of three years which we will use to filter our tables.</p></li>
<li><p><code>{% for year in years %}</code> - the SQL statement that will be repeated is placed inside the <code>for ...</code> loop. In this statement, for every year in the <code>years</code> variable list, we will repeat the following sql statement, where <code>{{ year }}</code> will be each year in the <code>years</code> variable:</p></li>
</ul>
<pre><code>SELECT * 
FROM {{ ref(&#39;citi_trips_long&#39;) }}
WHERE birth_year = {{ year }}
</code></pre>
<ul>
<li><code>{% endfor %}</code> - nothing more than marking the end of the for loop.</li>
</ul>
<p>Now, if we run the code <code>dbt compile --select jinja</code>, you will see a new <code>years.sql</code> appear under the <code>target/compiled/dbt_book/models/jinja/</code> directory.</p>
<p>Here is how the code looks like:</p>
<pre><code>SELECT * 
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
WHERE birth_year = 1995



SELECT * 
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
WHERE birth_year = 1997



SELECT * 
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
WHERE birth_year = 2002
</code></pre>
<p>What the <code>for</code> loop did was avoid the redundancy of selecting each <code>birth_year</code> in its own <code>SELECT</code> statement and instead put it inside one <code>for</code> loop statement. Going a step further, also the redundancy of hardcoding the <code>year</code> is removed. This formula, though a bit complicated, toes in line with the Do not Repeat Yourself (DRY) principle in programming.</p>
</div>
<div id="a-more-complex-jinja-query" class="section level2 hasAnchor" number="16.2">
<h2><span class="header-section-number">16.2</span> A more complex jinja query<a href="jinja.html#a-more-complex-jinja-query" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>One can also create more complex jinja queries that leverage other functionalities of SQL such as aggregation and CASE WHEN statements. Now suppose, for purely selfish reasons, this author wants to compare the bike ride durations against those of other people who are age mates as his siblings. Below is an <code>age.sql</code> file that creates a table that has a column showing the trip duration for each value in the <code>years</code> variable.</p>
<pre><code>{% set years = [1995, 1997, 2002] %}

SELECT birth_year, 
{% for year in years %}
SUM (CASE WHEN birth_year = {{ year }} THEN trip_min_round ELSE 0 END) AS trip_min_round_{{ year }},
{% endfor %}
SUM(trip_min_round) AS totals_trip_min_round
FROM {{ ref(&#39;citi_trips_long&#39;) }}
GROUP BY birth_year
</code></pre>
<p>In the corresponding <code>age.sql</code> in the <code>target</code> directory, this is the compiled SQL query result.</p>
<pre><code>SELECT birth_year, 

SUM(CASE WHEN birth_year = 1995 THEN trip_min_round ELSE 0 END) AS trip_min_round_1995,

SUM(CASE WHEN birth_year = 1997 THEN trip_min_round ELSE 0 END) AS trip_min_round_1997,

SUM(CASE WHEN birth_year = 2002 THEN trip_min_round ELSE 0 END) AS trip_min_round_2002,

SUM(trip_min_round) AS totals_trip_min_round
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
WHERE birth_year IN (
  
  
    1995, 
  
  
    1997, 
  
  
    2002
  
)
GROUP BY birth_year</code></pre>
<p>Pasting this query in BigQuery gives us the following table.</p>
<div class="float">
<img src="images/age_query.png" alt="Age query" />
<div class="figcaption">Age query</div>
</div>
<p>We can see a column for trip duration in minutes for each of the three select years of 1995, 1997 and 2002. However, other years not set in our <code>years</code> variable are included as well, but with the value <code>0</code> in each of the three columns. Before one starts getting confused and blaming the universe for not wanting us to succeed, there is a way we can sort this pesky issue: enter the <code>if not loop.last</code> statement!</p>
<p>In our previous SQL query, and if you are experienced with SQL queries a bit, you already know that one can sort the issue of excluding unnecessary years using the <code>WHERE</code> clause. For example, we would have used the clause <code>WHERE birth_year IN (1995, 1997, 2002)</code>. However, we frowned on this approach because it is making break the DRY principle by hardcoding the years by hand. Taking a more complex approach to fulfil the DRY principle sounds like we are exhibiting Obsessive Compulsive Disorder (OCD) but being obsessed in doing things in a higher way is not all too bad in programming.</p>
<p>The <a href="https://docs.y42.com/docs/how-to-use-jinja"><code>if not loop.last</code> statement</a> separates the values of interest with a comma, thus effectively fulfilling the work of where the <code>WHERE</code> clause failed. The <code>age2.sql</code> shows this in action.</p>
<pre><code>{% set years = [1995, 1997, 2002] %}

SELECT birth_year, 
{% for year in years %}
SUM(CASE WHEN birth_year = {{ year }} THEN trip_min_round ELSE 0 END) AS trip_min_round_{{ year }},
{% endfor %}
SUM(trip_min_round) AS totals_trip_min_round
FROM {{ ref(&#39;citi_trips_long&#39;) }}
WHERE birth_year IN (
  {% for year in years %}
  {# this will separate the years 1995, 1997 and 2002 with a comma, nothing out of this world #}
    {{ year }}{% if not loop.last %}, {% endif %}
  {% endfor %}
)
GROUP BY birth_year</code></pre>
<p>Running the <code>dbt compile --select jinja</code> code will compile the <code>age2.sql</code> inside the <code>target</code> directory. It’s contents are as follows. Notice the effect of the <code>if not loop.last</code> statement at the end and how it is a replicate of hardcoding <code>WHERE birth_year IN (1995, 1997, 2002)</code>.</p>
<pre><code>SELECT birth_year, 

SUM(CASE WHEN birth_year = 1995 THEN trip_min_round ELSE 0 END) AS trip_min_round_1995,

SUM(CASE WHEN birth_year = 1997 THEN trip_min_round ELSE 0 END) AS trip_min_round_1997,

SUM(CASE WHEN birth_year = 2002 THEN trip_min_round ELSE 0 END) AS trip_min_round_2002,

SUM(trip_min_round) AS totals_trip_min_round
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
WHERE birth_year IN (
  
  
    1995, 
  
  
    1997, 
  
  
    2002
  
)
GROUP BY birth_year</code></pre>
<p>Copy pasting the above compiled SQL into BigQuery you get a cleaner table with all the other birth years left out.</p>
<div class="float">
<img src="images/age2_query.png" alt="Age2 query" />
<div class="figcaption">Age2 query</div>
</div>
</div>
<div id="improvising-using-dry-principle" class="section level2 hasAnchor" number="16.3">
<h2><span class="header-section-number">16.3</span> Improvising using DRY Principle<a href="jinja.html#improvising-using-dry-principle" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can go a step further and make our table leaner, by eliminating all the <code>trip_min_round_&lt;year&gt;</code> columns and having just one <code>trip_min_round</code> summation column for the three years 1995, 1997 and 2002. The <code>ages3.sql</code> exemplifies this.</p>
<pre><code>{% set years = [1995, 1997, 2002] %}

SELECT birth_year, 
SUM(trip_min_round) AS totals_trip_min_round
FROM {{ ref(&#39;citi_trips_long&#39;) }}
WHERE birth_year IN (
  {% for year in years %}
  {# this will separate the years 1995, 1997 and 2002 with a comma, nothing out of this world #}
    {{ year }}{% if not loop.last %}, {% endif %}
  {% endfor %}
)
GROUP BY birth_year</code></pre>
<p>After running <code>dbt compile --select jinja</code>, the compiled <code>age3.sql</code> in the target directory is as follows:</p>
<pre><code>SELECT birth_year, 
SUM(trip_min_round) AS totals_trip_min_round
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`
WHERE birth_year IN (
  
  
    1995, 
  
  
    1997, 
  
  
    2002
  
)
GROUP BY birth_year</code></pre>
<p>For sure you get a leaner table which is far less verbose.</p>
<div class="float">
<img src="images/age3_query.png" alt="Age3 query" />
<div class="figcaption">Age3 query</div>
</div>
<p>One more thing, you can create views from the SQL jinja queries by simply running the trusty <code>dbt run --select jinja</code>. This is the resulting output.</p>
<pre><code>
--snip--
10:37:54  1 of 4 START sql view model nyc_bikes.age ...................................... [RUN]
10:37:59  1 of 4 OK created sql view model nyc_bikes.age ................................. [CREATE VIEW (0 processed) in 4.98s]
10:37:59  2 of 4 START sql view model nyc_bikes.age2 ..................................... [RUN]
10:38:04  2 of 4 OK created sql view model nyc_bikes.age2 ................................ [CREATE VIEW (0 processed) in 4.26s]
10:38:04  3 of 4 START sql view model nyc_bikes.age3 ..................................... [RUN]
10:38:06  3 of 4 OK created sql view model nyc_bikes.age3 ................................ [CREATE VIEW (0 processed) in 2.77s]
10:38:06  4 of 4 START sql view model nyc_bikes.years .................................... [RUN]
10:38:09  BigQuery adapter: https://console.cloud.google.com/bigquery?project=dbt-project-437116&amp;j=bq:africa-south1:ed8f842b-8077-418b-8222-f5e4cb9438d3&amp;page=queryresults
10:38:09  4 of 4 ERROR creating sql view model nyc_bikes.years ........................... [ERROR in 2.78s]
10:38:09  
10:38:09  Finished running 4 view models in 0 hours 0 minutes and 23.66 seconds (23.66s).
10:38:09  
10:38:09  Completed with 1 error and 0 warnings:
10:38:09  
10:38:09    Database Error in model years (models/jinja/years.sql)
  Syntax error: Expected end of input but got keyword SELECT at [15:1]
  compiled code at target/run/dbt_book/models/jinja/years.sql
  
--snip--</code></pre>
<p>The same views can be called out in BigQuery like the <code>age3</code> view shown below.</p>
<div class="float">
<img src="images/age3_bigquery.png" alt="Age3 view in bigquery" />
<div class="figcaption">Age3 view in bigquery</div>
</div>
<p>Now that the <code>{% if not loop.last %}</code> and its closing <code>{% endif %}</code> statements have ceased being cryptic, we can now sort out why the <code>years</code> view could not be created as seen in this <code>dbt run --select jinja</code> error.</p>
<pre><code>10:38:09  4 of 4 ERROR creating sql view model nyc_bikes.years ........................... [ERROR in 2.78s]</code></pre>
<p>If you look at the compiled SQL for the <code>years.sql</code> in the target directory, there are multiple SELECT statements each for a single year in the <code>years</code> variable. All those three SELECT statements cannot be run simoultaneously to produce a single table in BigQuery. But tweaking the <code>jinja/years.sql</code> a bit and using the <code>loop.last</code> statement will make all the difference. Here is the <code>jinja/years2.sql</code>.</p>
<pre><code>
{% set years = [1995, 1997, 2002] %}


SELECT * 
FROM {{ ref(&#39;citi_trips_long&#39;) }}

WHERE birth_year IN (
    {% for year in years %}
    
    {{ year }}
    {% if not loop.last %},{% endif %}
    {% endfor %}

)</code></pre>
<p>The <code>for</code> loop begins when we want to specify the years, jinja tells our computer to add a comma until the last one and the <code>endfor</code> statement tells our computer to break out of the looping. Here is the corresponding compiled SQL in the <code>years2.sql</code> in the target directory. When this query is pasted, into BigQuery, it only filters the rows matching to the specified birth years.</p>
<pre><code>SELECT * 
FROM `dbt-project-437116`.`nyc_bikes`.`citi_trips_long`

WHERE birth_year IN (
    
    
    1995
    ,
    
    
    1997
    ,
    
    
    2002
    
    

)</code></pre>
<div class="float">
<img src="images/years2_query.png" alt="Years 2 query" />
<div class="figcaption">Years 2 query</div>
</div>
<p>When we run <code>dbt run --select jinja</code>, this time round the <code>years2</code> view is created.</p>
<pre><code>--snip--
11:45:10  5 of 5 START sql view model nyc_bikes.years2 ................................... [RUN]
11:45:12  5 of 5 OK created sql view model nyc_bikes.years2 .............................. [CREATE VIEW (0 processed) in 2.29s]
--snip--</code></pre>

</div>
</div>







            </section>

          </div>
        </div>
      </div>
<a href="exposures.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/15-jinja.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
