<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 13 Snapshots | dbt Book</title>
  <meta name="description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 13 Snapshots | dbt Book" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 13 Snapshots | dbt Book" />
  
  <meta name="twitter:description" content="<p>This is a minimal example of using the bookdown package to write a book.
The HTML output format for this example is bookdown::gitbook,
set in the _output.yml file.</p>" />
  

<meta name="author" content="Samuel Gachuhi Ngugi" />


<meta name="date" content="2024-11-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="sources-1.html"/>
<link rel="next" href="analyses.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#usage"><i class="fa fa-check"></i><b>1.1</b> Usage</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#render-book"><i class="fa fa-check"></i><b>1.2</b> Render book</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#preview-book"><i class="fa fa-check"></i><b>1.3</b> Preview book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#what-is-dbt"><i class="fa fa-check"></i><b>2.1</b> What is dbt?</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#encounter-with-dbt"><i class="fa fa-check"></i><b>2.2</b> Encounter with <code>dbt</code></a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#dbt-from-the-professionals"><i class="fa fa-check"></i><b>2.3</b> dbt, from the professionals…</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#why-use-dbt"><i class="fa fa-check"></i><b>2.4</b> Why use dbt?</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html"><i class="fa fa-check"></i><b>3</b> The <code>dbt</code> architecture</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#models"><i class="fa fa-check"></i><b>3.0.1</b> Models</a></li>
<li class="chapter" data-level="3.0.2" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#tests"><i class="fa fa-check"></i><b>3.0.2</b> Tests</a></li>
<li class="chapter" data-level="3.0.3" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#documentation"><i class="fa fa-check"></i><b>3.0.3</b> Documentation</a></li>
<li class="chapter" data-level="3.0.4" data-path="the-dbt-architecture.html"><a href="the-dbt-architecture.html#sources"><i class="fa fa-check"></i><b>3.0.4</b> Sources</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-storage.html"><a href="data-storage.html"><i class="fa fa-check"></i><b>4</b> Data storage</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-storage.html"><a href="data-storage.html#data-warehouse"><i class="fa fa-check"></i><b>4.1</b> Data warehouse</a></li>
<li class="chapter" data-level="4.2" data-path="data-storage.html"><a href="data-storage.html#data-lake"><i class="fa fa-check"></i><b>4.2</b> Data lake</a></li>
<li class="chapter" data-level="4.3" data-path="data-storage.html"><a href="data-storage.html#data-lakehouse"><i class="fa fa-check"></i><b>4.3</b> Data lakehouse</a></li>
<li class="chapter" data-level="4.4" data-path="data-storage.html"><a href="data-storage.html#a-brief-history"><i class="fa fa-check"></i><b>4.4</b> A brief history</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html"><i class="fa fa-check"></i><b>5</b> Our data in BigQuery</a>
<ul>
<li class="chapter" data-level="5.1" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#accessing-big-query"><i class="fa fa-check"></i><b>5.1</b> Accessing Big Query</a></li>
<li class="chapter" data-level="5.2" data-path="our-data-in-bigquery.html"><a href="our-data-in-bigquery.html#copying-the-new-york-city-bikes-data"><i class="fa fa-check"></i><b>5.2</b> Copying the New York City Bikes data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="installing-dbt.html"><a href="installing-dbt.html"><i class="fa fa-check"></i><b>6</b> Installing dbt</a>
<ul>
<li class="chapter" data-level="6.1" data-path="installing-dbt.html"><a href="installing-dbt.html#setting-the-environment"><i class="fa fa-check"></i><b>6.1</b> Setting the environment</a></li>
<li class="chapter" data-level="6.2" data-path="installing-dbt.html"><a href="installing-dbt.html#connecting-to-your-bigquery-data-warehouse"><i class="fa fa-check"></i><b>6.2</b> Connecting to your BigQuery data warehouse</a></li>
<li class="chapter" data-level="6.3" data-path="installing-dbt.html"><a href="installing-dbt.html#initializing-a-dbt-project"><i class="fa fa-check"></i><b>6.3</b> Initializing a dbt project</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="models-1.html"><a href="models-1.html"><i class="fa fa-check"></i><b>7</b> Models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="models-1.html"><a href="models-1.html#running-a-model"><i class="fa fa-check"></i><b>7.1</b> Running a model</a></li>
<li class="chapter" data-level="7.2" data-path="models-1.html"><a href="models-1.html#model-structure"><i class="fa fa-check"></i><b>7.2</b> Model structure</a></li>
<li class="chapter" data-level="7.3" data-path="models-1.html"><a href="models-1.html#a-custom-model"><i class="fa fa-check"></i><b>7.3</b> A custom model</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="documentation-1.html"><a href="documentation-1.html"><i class="fa fa-check"></i><b>8</b> Documentation</a>
<ul>
<li class="chapter" data-level="8.1" data-path="documentation-1.html"><a href="documentation-1.html#the-yml-files"><i class="fa fa-check"></i><b>8.1</b> The yml files</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="documentation-1.html"><a href="documentation-1.html#version-2"><i class="fa fa-check"></i><b>8.1.1</b> <code>version: 2</code></a></li>
<li class="chapter" data-level="8.1.2" data-path="documentation-1.html"><a href="documentation-1.html#models-2"><i class="fa fa-check"></i><b>8.1.2</b> <code>models</code></a></li>
<li class="chapter" data-level="8.1.3" data-path="documentation-1.html"><a href="documentation-1.html#description"><i class="fa fa-check"></i><b>8.1.3</b> <code>description</code></a></li>
<li class="chapter" data-level="8.1.4" data-path="documentation-1.html"><a href="documentation-1.html#columns"><i class="fa fa-check"></i><b>8.1.4</b> <code>columns</code></a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="documentation-1.html"><a href="documentation-1.html#definition-for-our-model"><i class="fa fa-check"></i><b>8.2</b> Definition for our model</a></li>
<li class="chapter" data-level="8.3" data-path="documentation-1.html"><a href="documentation-1.html#using-the-doc-function"><i class="fa fa-check"></i><b>8.3</b> Using the <code>doc</code> function</a></li>
<li class="chapter" data-level="8.4" data-path="documentation-1.html"><a href="documentation-1.html#images-in-dbt-documentation"><i class="fa fa-check"></i><b>8.4</b> Images in dbt documentation</a></li>
<li class="chapter" data-level="8.5" data-path="documentation-1.html"><a href="documentation-1.html#generating-the-document"><i class="fa fa-check"></i><b>8.5</b> Generating the document</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="tests-1.html"><a href="tests-1.html"><i class="fa fa-check"></i><b>9</b> Tests</a>
<ul>
<li class="chapter" data-level="9.1" data-path="tests-1.html"><a href="tests-1.html#types-of-tests-in-dbt"><i class="fa fa-check"></i><b>9.1</b> Types of tests in dbt</a></li>
<li class="chapter" data-level="9.2" data-path="tests-1.html"><a href="tests-1.html#generic-tests-in-dbt"><i class="fa fa-check"></i><b>9.2</b> Generic tests in dbt</a></li>
<li class="chapter" data-level="9.3" data-path="tests-1.html"><a href="tests-1.html#singular-tests-in-dbt"><i class="fa fa-check"></i><b>9.3</b> Singular tests in dbt</a></li>
<li class="chapter" data-level="9.4" data-path="tests-1.html"><a href="tests-1.html#creating-a-generic-test"><i class="fa fa-check"></i><b>9.4</b> Creating a generic test</a></li>
<li class="chapter" data-level="9.5" data-path="tests-1.html"><a href="tests-1.html#configuring-custom-generic-tests"><i class="fa fa-check"></i><b>9.5</b> Configuring custom generic tests</a></li>
<li class="chapter" data-level="9.6" data-path="tests-1.html"><a href="tests-1.html#storing-test-failures"><i class="fa fa-check"></i><b>9.6</b> Storing test failures</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html"><i class="fa fa-check"></i><b>10</b> dbt Expectations package</a>
<ul>
<li class="chapter" data-level="10.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#dbt-expectations-installation"><i class="fa fa-check"></i><b>10.1</b> <code>dbt-expectations</code> installation</a></li>
<li class="chapter" data-level="10.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#types-of-dbt-expectations-tests"><i class="fa fa-check"></i><b>10.2</b> Types of <code>dbt-expectations</code> tests</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#table-shape"><i class="fa fa-check"></i><b>10.2.1</b> Table shape</a></li>
<li class="chapter" data-level="10.2.2" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#missing-values-unique-values-and-types"><i class="fa fa-check"></i><b>10.2.2</b> Missing values, unique values, and types</a></li>
<li class="chapter" data-level="10.2.3" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#sets-and-ranges"><i class="fa fa-check"></i><b>10.2.3</b> Sets and Ranges</a></li>
<li class="chapter" data-level="10.2.4" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#string-matching"><i class="fa fa-check"></i><b>10.2.4</b> String matching</a></li>
<li class="chapter" data-level="10.2.5" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#aggregate"><i class="fa fa-check"></i><b>10.2.5</b> Aggregate</a></li>
<li class="chapter" data-level="10.2.6" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#multi-column"><i class="fa fa-check"></i><b>10.2.6</b> Multi-column</a></li>
<li class="chapter" data-level="10.2.7" data-path="dbt-expectations-package.html"><a href="dbt-expectations-package.html#distributional-functions"><i class="fa fa-check"></i><b>10.2.7</b> Distributional functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="seeds.html"><a href="seeds.html"><i class="fa fa-check"></i><b>11</b> Seeds</a>
<ul>
<li class="chapter" data-level="11.1" data-path="seeds.html"><a href="seeds.html#uploading-a-seed-into-your-data-warehouse"><i class="fa fa-check"></i><b>11.1</b> Uploading a seed into your data warehouse</a></li>
<li class="chapter" data-level="11.2" data-path="seeds.html"><a href="seeds.html#referencing-seeds-in-models"><i class="fa fa-check"></i><b>11.2</b> Referencing seeds in models</a></li>
<li class="chapter" data-level="11.3" data-path="seeds.html"><a href="seeds.html#seed-configurations-at-project-level"><i class="fa fa-check"></i><b>11.3</b> Seed Configurations at project level</a></li>
<li class="chapter" data-level="11.4" data-path="seeds.html"><a href="seeds.html#seed-properties-and-configurations-at-properties-level"><i class="fa fa-check"></i><b>11.4</b> Seed properties and configurations at properties level</a></li>
<li class="chapter" data-level="11.5" data-path="seeds.html"><a href="seeds.html#performing-tests-on-seeds"><i class="fa fa-check"></i><b>11.5</b> Performing tests on seeds</a></li>
<li class="chapter" data-level="11.6" data-path="seeds.html"><a href="seeds.html#viewing-documentation-for-dbt-seeds"><i class="fa fa-check"></i><b>11.6</b> Viewing documentation for dbt seeds</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="sources-1.html"><a href="sources-1.html"><i class="fa fa-check"></i><b>12</b> Sources</a>
<ul>
<li class="chapter" data-level="12.1" data-path="sources-1.html"><a href="sources-1.html#defining-a-source"><i class="fa fa-check"></i><b>12.1</b> Defining a source</a></li>
<li class="chapter" data-level="12.2" data-path="sources-1.html"><a href="sources-1.html#referencing-sources"><i class="fa fa-check"></i><b>12.2</b> Referencing sources</a></li>
<li class="chapter" data-level="12.3" data-path="sources-1.html"><a href="sources-1.html#defining-properties-in-a-sources-file"><i class="fa fa-check"></i><b>12.3</b> Defining properties in a <code>sources</code> file</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="snapshots.html"><a href="snapshots.html"><i class="fa fa-check"></i><b>13</b> Snapshots</a>
<ul>
<li class="chapter" data-level="13.1" data-path="snapshots.html"><a href="snapshots.html#create-a-snapshot"><i class="fa fa-check"></i><b>13.1</b> Create a snapshot</a></li>
<li class="chapter" data-level="13.2" data-path="snapshots.html"><a href="snapshots.html#the-check-strategy"><i class="fa fa-check"></i><b>13.2</b> The <code>check</code> strategy</a></li>
<li class="chapter" data-level="13.3" data-path="snapshots.html"><a href="snapshots.html#the-timestamp-strategy"><i class="fa fa-check"></i><b>13.3</b> The <code>timestamp</code> strategy</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="analyses.html"><a href="analyses.html"><i class="fa fa-check"></i><b>14</b> Analyses</a>
<ul>
<li class="chapter" data-level="14.1" data-path="analyses.html"><a href="analyses.html#creating-an-analysis"><i class="fa fa-check"></i><b>14.1</b> Creating an <code>analysis</code></a></li>
<li class="chapter" data-level="14.2" data-path="analyses.html"><a href="analyses.html#definitions-for-analyses"><i class="fa fa-check"></i><b>14.2</b> Definitions for <code>analyses</code></a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="exposures.html"><a href="exposures.html"><i class="fa fa-check"></i><b>15</b> Exposures</a>
<ul>
<li class="chapter" data-level="15.1" data-path="exposures.html"><a href="exposures.html#creating-an-exposure"><i class="fa fa-check"></i><b>15.1</b> Creating an exposure</a></li>
<li class="chapter" data-level="15.2" data-path="exposures.html"><a href="exposures.html#visualizing-the-exposure"><i class="fa fa-check"></i><b>15.2</b> Visualizing the exposure</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="jinja.html"><a href="jinja.html"><i class="fa fa-check"></i><b>16</b> Jinja</a>
<ul>
<li class="chapter" data-level="16.1" data-path="jinja.html"><a href="jinja.html#a-simple-jinja-statement"><i class="fa fa-check"></i><b>16.1</b> A simple jinja statement</a></li>
<li class="chapter" data-level="16.2" data-path="jinja.html"><a href="jinja.html#a-more-complex-jinja-query"><i class="fa fa-check"></i><b>16.2</b> A more complex jinja query</a></li>
<li class="chapter" data-level="16.3" data-path="jinja.html"><a href="jinja.html#improvising-using-dry-principle"><i class="fa fa-check"></i><b>16.3</b> Improvising using DRY Principle</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="macros.html"><a href="macros.html"><i class="fa fa-check"></i><b>17</b> Macros</a>
<ul>
<li class="chapter" data-level="17.1" data-path="macros.html"><a href="macros.html#invoking-a-macro"><i class="fa fa-check"></i><b>17.1</b> Invoking a macro</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="macros.html"><a href="macros.html#invoking-a-macro-using-expression-blocks"><i class="fa fa-check"></i><b>17.1.1</b> Invoking a macro using expression blocks</a></li>
<li class="chapter" data-level="17.1.2" data-path="macros.html"><a href="macros.html#invoke-a-macro-using-call-blocks"><i class="fa fa-check"></i><b>17.1.2</b> Invoke a macro using call blocks</a></li>
<li class="chapter" data-level="17.1.3" data-path="macros.html"><a href="macros.html#invoke-a-macro-from-the-command-line-interface-cli"><i class="fa fa-check"></i><b>17.1.3</b> Invoke a macro from the Command Line Interface (CLI)</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="macros.html"><a href="macros.html#simple-macro"><i class="fa fa-check"></i><b>17.2</b> Simple macro</a></li>
<li class="chapter" data-level="17.3" data-path="macros.html"><a href="macros.html#complex-macro"><i class="fa fa-check"></i><b>17.3</b> Complex macro</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">dbt Book</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="snapshots" class="section level1 hasAnchor" number="13">
<h1><span class="header-section-number">Chapter 13</span> Snapshots<a href="snapshots.html#snapshots" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Picture this, there is this lady you have been eyeing, after many nights of turning and tossing, you decide to visit her place because she is currently not anywhere interested in being taken out. When you visit her at the rendezvous, you decide to ask her to take a ‘selfie’ of you and her (big mistake). You think she will send the selfie to you, she never does. Well, that’s a true story of yours truly and even though no hard feelings over the incident, snapshots in dbt work in much the same way.</p>
<p>A snapshot in dbt is a recorded change of a mutable table over time. Think of a snapshot as a way to track changes in your data over time. For example, you could be a having a crazy table that logs your relationship status with your girlfriend or boyfriend over time. The first row could be as follows:</p>
<pre><code>|----------|--------------|---------------|
| id       |  Status      | updated-at    |
| 11       |  Spark       | 21/09/2024    |
|----------|--------------|---------------|</code></pre>
<p>Now let’s say, you realise something about your girlfriend and boyfriend that puts a freeze on the relationship, so in your relationship table it would have the following update.</p>
<pre><code>|----------|--------------|---------------|
| id       |  Status      | updated-at    |
| 11       |  Shaky       | 22/10/2024    |
|----------|--------------|---------------|</code></pre>
<p>The relationship would now be ‘shaky’ subject to external forces and internal will, but our update may have overwritten the previous record of ‘Spark’ when the relationship was at cloud nine. dbt offers a way to preserve these past records so that they can be used for further analysis, or for posterity purposes. For example, keeping a record of the change can be used to analyse how long the relationship lasted from its hey days to when the waves started beating the ship. This kind of analysis can be used for more serious matters, such as when analyzing the time it takes from sending to receiving an order. dbt will help you record these changes and log the time when the change took place. For example, our dbt snapshot for our relationship would be:</p>
<p>|———-|————–|—————|—————-|————–|
| id | Status | updated-at | dbt_valid_from | dbt_valid_to |
| 11 | Spark | 21/09/2024 | 21/09/2024 | 22/10/2024 |
| 11 | Shaky | 22/10/2024 | 22/10/2024 | null |
|———-|————–|—————|—————-|————–|</p>
<p>The most up-to-date record will have a value of <code>null</code> in the <code>dbt_valid_to</code> field. Here is a description of the last two fields and those used internally by dbt.</p>
<ol style="list-style-type: decimal">
<li><p><code>dbt_valid_from</code> - The timestamp when this snapshot row was first inserted. This column can be used to order the different “versions” of a record.</p></li>
<li><p><code>dbt_valid_to</code> - The timestamp when this row became invalidated. The most recent snapshot record will have dbt_valid_to set to null.</p></li>
<li><p><code>dbt_scd_id</code> - A unique key generated for each snapshotted record. This is used internally by dbt.</p></li>
<li><p><code>dbt_updated_at</code> - The updated_at timestamp of the source record when this snapshot row was inserted. This is used internally by dbt.</p></li>
</ol>
<p>Slowly Changing Dimension (SCD) refers to the way data changes over time in a data warehouse. In today’s world, one wouldn’t say that data changes slowly, but the term arises from the fact that even though data may change infrequently, such as makeups and breakups in your relationship, they are significant over time even to the future of the relationship or the continuity of your business!</p>
<p>SCDs are typically of three types:</p>
<ul>
<li><p><strong>Type 1</strong>: This is where old data is overwritten without any preservation of its history. Old data ceases to exist with update of new data.</p></li>
<li><p><strong>Type 2</strong>: When a new record of data is added, the old record is preserved as historical data. This is the most common type of SCD and which dbt implements.</p></li>
<li><p><strong>Type 3</strong>: This approach adds a new column for the new data and preserves the old data in the original column. This type is best used to see the progression of changes <em>rather</em> than when a change happened.</p></li>
</ul>
<p>Therefore, when <em>snapshoting</em> in dbt, when a change occurs in the source data, instead of overwriting the existing record (Type 1) or a dding a new column (Type 3), dbt adds a new record with the new data (Type 2). The <code>dbt_valid_from</code> and <code>dbt_valid_to</code> columns in the snapshot table indicate when each version of the record was valid, allowing you to track the full history of changes over time. This looks much like git commits, only that the commits are in tabular form.</p>
<div id="create-a-snapshot" class="section level2 hasAnchor" number="13.1">
<h2><span class="header-section-number">13.1</span> Create a snapshot<a href="snapshots.html#create-a-snapshot" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Creating a snapshot in dbt to some extent depends on the version you are using. Starting from version 1.9, you will actually need two files to perform a dbt snapshot. These are the YAML and sql files. However, this tutorial was written using version 1.8.7. To know the dbt version you are using, type <code>dbt debug</code>. You will see your version listed like so:</p>
<pre><code>--snip--
19:41:25  Running with dbt=1.8.7
19:41:25  dbt version: 1.8.7
19:41:25  python version: 3.10.12
--snip--</code></pre>
<p>Now to create a snapshot using dbt versions lower than for 1.9, you will create a snapshot SQL file with the following configurations.</p>
<pre><code>{% snapshot tripdata_snapshot %}

{{
  config(      
    target_schema=&#39;snapshots&#39;,      
    strategy=&#39;check&#39;,      
    unique_key=&#39;_id&#39;,      
    check_cols=&#39;all&#39;    
  )  
}}  

SELECT * FROM {{ source(&#39;nyc_bikes_nyc_bikes2014&#39;, &#39;2014-tripdata&#39;) }}

{% endsnapshot %}</code></pre>
<p>Let’s go through it line by line. The macros <code>{% snapshot tripdata_snapshot %}</code> and <code>{% endsnapshot %}</code> indicate that this is a snapshot file. Your configurations will go inside the <code>config()</code> function.</p>
<p><code>target_schema</code> - this is the schema in which your snapshot will be stored.</p>
<p><code>strategy</code> - this is the mechanism by which dbt will know that a row has changed. The <code>timestamp</code> strategy, and the most recommended for that matter, uses an <code>updated_at</code> column to determine if a row has changed. On the other hand, the <code>check</code> strategy compares a list of columns between their current and historical state to determine what has changed. Use the <code>check</code> strategy if there is no reliable <code>updated_at</code> column for tracking changes with time, as in our case.</p>
<p><code>unique_key</code> - this is the unique key in your table that dbt will use.</p>
<p><code>check_cols</code> - These are the columns to check for changes. The <code>all</code> parameter can be passed in case you want to track changes in all the columns of the row.</p>
<p>One can also add an additional <code>invalidate_hard_deletes</code> <a href="https://docs.getdbt.com/docs/build/snapshots">configuration</a> to track rows that have been deleted. The <code>dbt_valid_to</code> column of deleted rows will be set to the current snapshot time.</p>
<p>Finally, the <code>SELECT</code> statement. You will insert inside the <code>source()</code> function the table in which you would like to track changes.</p>
<p>Thereafter, run <code>dbt snapshot</code>. Below is the output.</p>
<pre><code>21:01:01  Concurrency: 1 threads (target=&#39;dev&#39;)
21:01:01  
21:01:01  1 of 1 START snapshot snapshots.tripdata_snapshot .............................. [RUN]
21:01:11  1 of 1 OK snapshotted snapshots.tripdata_snapshot .............................. [CREATE TABLE (224.7k rows, 33.3 MiB processed) in 10.03s]
21:01:11  
21:01:11  Finished running 1 snapshot in 0 hours 0 minutes and 17.65 seconds (17.65s).
21:01:12  
21:01:12  Completed successfully
21:01:12  
21:01:12  Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1</code></pre>
<p>A new table should appear under the <code>snapshots</code> schema in BigQuery.</p>
<div class="float">
<img src="images/snapshots_schema.png" alt="Snapshots schema" />
<div class="figcaption">Snapshots schema</div>
</div>
<p>When you run <code>dbt snapshot</code> the first time, the <code>dbt_valid_to</code> column will be <code>null</code> for all records. Thereafter, when you run subsequent <code>dbt snapshot</code> executions for a table that has undergone a change, the <code>dbt_valid_to</code> will be populated with a timestamp value in the <code>dbt_valid_to</code> of the altered row.</p>
</div>
<div id="the-check-strategy" class="section level2 hasAnchor" number="13.2">
<h2><span class="header-section-number">13.2</span> The <code>check</code> strategy<a href="snapshots.html#the-check-strategy" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now is the time to truly test if our snapshots work. Go to the SQL tab of your Big Query and insert a new row using this query:</p>
<pre><code>INSERT INTO `dbt-project-437116`.`nyc_bikes_nyc_bikes2014`.`2014-tripdata` (`_id`, `tripduration`, `start station name`) 
VALUES (000000, 1000, &#39;Nowhere Near Station&#39;);</code></pre>
<p>Thereafter run <code>dbt snapshot</code>.</p>
<p>Ensure that the new row has been added by crosschecking its existence via:</p>
<pre><code>SELECT * FROM `dbt-project-437116`.`nyc_bikes_nyc_bikes2014`.`2014-tripdata`
WHERE `start station name` = &#39;Nowhere Near Station&#39;;</code></pre>
<p>Now check if our <code>tripdata_snapshot</code> table has captured the new row using the below query.</p>
<pre><code>SELECT * FROM `dbt-project-437116`.`snapshots`.`tripdata_snapshot`
WHERE `start station name` = &#39;Nowhere Near Station&#39;;</code></pre>
<p>Its a new row of data, which means all columns have been affected with a new value in each. Remember we set the <code>check_cols=all</code>.</p>
<div class="float">
<img src="images/inserted_new_row.png" alt="Recorded change" />
<div class="figcaption">Recorded change</div>
</div>
<p>Let’s go on.</p>
<p>Insert a new row, with an additional extra change in the <code>_id</code> column.</p>
<pre><code>UPDATE `dbt-project-437116`.`nyc_bikes_nyc_bikes2014`.`2014-tripdata`
SET `start station name` = &#39;Even Further Station&#39;, `_id` = 1001995
WHERE `_id` = 0;</code></pre>
<p>Again, run <code>dbt snapshot</code>. Always run <code>dbt snapshot</code> when you suspect, or where in actual sense your table has been updated, even if through automatic scheduling.</p>
<p>Let’s check if the new row with two updates has been recorded in our snapshots table.</p>
<pre><code>SELECT * FROM `dbt-project-437116`.`snapshots`.`tripdata_snapshot`
WHERE `start station name` = &#39;Even Further Station&#39;;</code></pre>
<p>If you run this, you will notice that the <code>dbt_valid_to</code> is still <code>null</code>. We presume this is because we have added a new unique key and thus dbt will still treat this as a new recorded rather than one which was changed from 0 to 1001995.</p>
<p>Now, update the row with <code>_id</code> 1001995 using the below SQL query.</p>
<pre><code>UPDATE `dbt-project-437116`.`nyc_bikes_nyc_bikes2014`.`2014-tripdata`
SET `start station name` = &#39;Furth East Station&#39;
WHERE `_id` = 1001995;</code></pre>
<p>Now after running <code>dbt snapshot</code> (we hope you remembered), let’s see if our snapshot table will have tracked the historical change of <code>Even Further Station</code> and <code>Furth East Station</code> of row <code>_id</code> 1001995. Use the below query to unravel the results, drumrolls please…</p>
<pre><code>SELECT * FROM `dbt-project-437116`.`snapshots`.`tripdata_snapshot`
WHERE `_id` = 1001995;</code></pre>
<div class="float">
<img src="images/snapshot_example.png" alt="Snapshot example" />
<div class="figcaption">Snapshot example</div>
</div>
<p>Yes it did! For row 1, which stands for when the ‘start station name’ was <code>Even Further Station</code>, we can see that row was valid from 2024-10-24 19:29 to 2024-10-24 20:02. However, the new row 2, which is where the ‘start station name’ was switched to <code>Furth East Station</code>, we can see it became valid from 2024-10-24 20:02, the exact time when row was updated.</p>
<p>You can indeed check if the latest change is in the <code>2014-tripdata</code> table via:</p>
<pre><code>SELECT * FROM `dbt-project-437116`.`nyc_bikes_nyc_bikes2014`.`2014-tripdata`
WHERE `start station name` = &#39;Furth East Station&#39;;</code></pre>
</div>
<div id="the-timestamp-strategy" class="section level2 hasAnchor" number="13.3">
<h2><span class="header-section-number">13.3</span> The <code>timestamp</code> strategy<a href="snapshots.html#the-timestamp-strategy" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>timestamp</code> strategy in snapshoting relies on an <code>updated_at</code> column to check if any changes have occurred on the row. If the configured <code>updated_at</code> column is more recent than when the table was last run, dbt will invalidate the old record and record a new one. If the timestamps are unchanged, dbt will not take any action.</p>
<p>The <code>timestamp</code> strategy requires an <code>updated_at</code> column which represents when the row was last updated. In order to work with <code>timestamp</code> strategy, we need to recreate our <code>2014-tripdata</code> but now with an additional <code>updated_at</code> column. It can be any table, so long as there is an <code>updated_at</code> column, but we settled on this one because it is lightweight and plus, we already have it as a seed. We will use a dbt model to recreated the <code>2014-tripdata</code> seed but with an extra <code>updated_at</code> column.</p>
<p>Create a <code>nyc_bikes_timestamp</code> SQL model inside the <code>sources</code> folder. Copy paste the following contents into the model.</p>
<pre><code>{{ config(
    materialized=&quot;table&quot;,
    schema=&quot;nyc_bikes_nyc_bikes2014&quot;
) }}

WITH nyc_bikes_timestamp AS (
  SELECT *, CURRENT_TIMESTAMP() AS updated_at FROM {{ source(&#39;nyc_bikes_nyc_bikes2014&#39;, &#39;2014-tripdata&#39;) }}
)

SELECT
  *
FROM nyc_bikes_timestamp</code></pre>
<div class="float">
<img src="images/timestamp_table.png" alt="Timestamp table" />
<div class="figcaption">Timestamp table</div>
</div>
<p>We are configuring it as a table because for some reason, when trying to update fields into this model using BigQuery, an error came up simply because it was a view!</p>
<p>Now run <code>dbt run --select sources</code>. You will get the below output.</p>
<pre><code>19:08:14  Concurrency: 1 threads (target=&#39;dev&#39;)
19:08:14  
19:08:14  1 of 4 START sql view model nyc_bikes.nyc_bikes_male ........................... [RUN]
19:08:16  1 of 4 OK created sql view model nyc_bikes.nyc_bikes_male ...................... [CREATE VIEW (0 processed) in 2.45s]
19:08:16  2 of 4 START sql table model nyc_bikes_nyc_bikes_nyc_bikes2014.nyc_bikes_timestamp  [RUN]
19:08:22  2 of 4 OK created sql table model nyc_bikes_nyc_bikes_nyc_bikes2014.nyc_bikes_timestamp  [CREATE TABLE (224.7k rows, 33.3 MiB processed) in 5.31s]
19:08:22  3 of 4 START sql view model nyc_bikes.nyc_female_2014 .......................... [RUN]
19:08:24  3 of 4 OK created sql view model nyc_bikes.nyc_female_2014 ..................... [CREATE VIEW (0 processed) in 2.22s]
19:08:24  4 of 4 START sql view model nyc_bikes.nyc_male_2014 ............................ [RUN]
19:08:26  4 of 4 OK created sql view model nyc_bikes.nyc_male_2014 ....................... [CREATE VIEW (0 processed) in 2.39s]
19:08:26  
19:08:26  Finished running 3 view models, 1 table model in 0 hours 0 minutes and 29.78 seconds (29.78s).
19:08:26  
19:08:26  Completed successfully
19:08:26  
19:08:26  Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4</code></pre>
<p>Now that we have already created a table of <code>nyc_bikes_timestamp</code>, we would also want to reference it in downstream models. As you read in an earlier chapter, dbt sources are what make models to be referenced in other queries using the <code>source()</code> function. Therefore in the <code>sources/sources_bikes.yml</code>, add the following:</p>
<pre><code>- name: nyc_bikes_nyc_bikes_nyc_bikes2014
        schema: nyc_bikes_nyc_bikes_nyc_bikes2014
        tables:
          - name: nyc_bikes_timestamp
            description: &#39;&#39;</code></pre>
<p>Now is the time to create a dbt snapshot relying on the <code>timestamp</code> strategy.</p>
<p>Create a <code>timestamp_snapshot</code> in the <code>snapshots</code> directory with the following SQL contents.</p>
<pre><code>{% snapshot timestamp_snapshot %}

{{
  config(      
    target_schema=&#39;snapshots&#39;,      
    strategy=&#39;timestamp&#39;,      
    unique_key=&#39;_id&#39;,      
    updated_at=&#39;updated_at&#39;    
  )  
}}  

SELECT * FROM `dbt-project-437116`.`nyc_bikes_nyc_bikes_nyc_bikes2014`.`nyc_bikes_timestamp`

{% endsnapshot %}
</code></pre>
<p>You may wonder why we are not using something like <code>{{ source("schema", "table") }}</code> in the SELECT statement. We had initially run that with <code>nyc_bikes_nyc_bikes_nyc_bikes2014</code> and <code>nyc_bikes_timestamp</code> as the schema and table names respectively. However, dbt kept throwing an error that it couldn’t find a table therefore we resulted in the unorthodox way of hardcoding the entire dataset-schema-table namespace.</p>
<p>Now run <code>dbt snapshot</code> to create the <code>nyc_bikes_timestamp</code> table.</p>
<pre><code>19:31:54  Concurrency: 1 threads (target=&#39;dev&#39;)
19:31:54  
19:31:54  1 of 2 START snapshot snapshots.timestamp_snapshot ............................. [RUN]
19:32:02  1 of 2 OK snapshotted snapshots.timestamp_snapshot ............................. [CREATE TABLE (224.7k rows, 35.0 MiB processed) in 8.10s]
19:32:02  2 of 2 START snapshot snapshots.tripdata_snapshot .............................. [RUN]
19:32:15  2 of 2 OK snapshotted snapshots.tripdata_snapshot .............................. [MERGE (0.0 rows, 44.0 MiB processed) in 12.54s]
19:32:15  
19:32:15  Finished running 2 snapshots in 0 hours 0 minutes and 28.86 seconds (28.86s).
19:32:15  
19:32:15  Completed successfully
19:32:15  
19:32:15  Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2</code></pre>
<div class="float">
<img src="images/timestamp_snapshot_created.png" alt="Timestamp snapshot" />
<div class="figcaption">Timestamp snapshot</div>
</div>
<p>Now to check if our timestamp table can snapshot changes, let’s insert a new row and make some changes to it. Paste the following in a SQL tab in BigQuery.</p>
<pre><code>INSERT INTO `dbt-project-437116`.`nyc_bikes_nyc_bikes_nyc_bikes2014`.`nyc_bikes_timestamp` (`_id`, `tripduration`, `start station name`, `updated_at`) 
VALUES (21001995, 2000, &#39;Sumwhere Near Station&#39;, &#39;2024-10-25 23:09:47.169668 UTC&#39;);</code></pre>
<p>Note the <code>updated_at</code> column. Unlike when working with the <code>check</code> strategy which could still work well with several fields as <code>null</code>, omitting the <code>updated_at</code> column in the <code>timestamp</code> strategy is costly as dbt will be unable to track any change. All you will get just a new field but with several <code>null</code> values in the snapshot table.</p>
<p>Now run <code>dbt snapshot</code> and when it succesfully runs, check <code>timestamp_snapshot</code> table using this SELECT statement in BigQuery.</p>
<pre><code>SELECT * FROM `dbt-project-437116`.`snapshots`.`timestamp_snapshot` 
WHERE `_id` = 21001995;</code></pre>
<p>Now change the station name from ‘Sumwhere Here Station` to ’Somewhere Near Station’ to demonstrate tracking a change.</p>
<pre><code>UPDATE `dbt-project-437116`.`nyc_bikes_nyc_bikes_nyc_bikes2014`.`nyc_bikes_timestamp`
SET `start station name` = &#39;Somewhere Here Station&#39;, `updated_at` = &#39;2024-10-25 23:14:47.169668 UTC&#39;
WHERE `_id` = 21001995;</code></pre>
<p>Run <code>dbt snapshot</code>. Again, we are careful not to omit the <code>updated_at</code> column!</p>
<p>Now check if dbt has been able to track changes. We expect that the row with the station name ‘Sumwhere Near Station’ was valid for a short period (see the <code>dbt_valid_from</code> and <code>dbt_valid_to</code> columns) while the ‘Somewhere Here Station’ is the most current.</p>
<pre><code>SELECT * FROM `dbt-project-437116`.`snapshots`.`timestamp_snapshot` 
WHERE `_id` = 21001995;</code></pre>
<p>You should see we’ve been able to track changes.</p>
<div class="float">
<img src="images/timestamp_tracking.png" alt="Timestamp tracking" />
<div class="figcaption">Timestamp tracking</div>
</div>
<p>The downside of using the <code>timestamp</code> strategy is that you have to use the <code>updated_at</code> column or whatever timestamp column you defined. Nevertheless, based on our exercise so far, the <code>check</code> strategy is far much better and less taxing.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="sources-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="analyses.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/12-snapshots.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
